// Grouping module
"use strict";
;(function($){$.extend($.jgrid,{template:function(b){var c=$.makeArray(arguments).slice(1),j=1;if(b===undefined){b=""}return b.replace(/\{([\w\-]+)(?:\:([\w\.]*)(?:\((.*?)?\))?)?\}/g,function(m,i){if(!isNaN(parseInt(i,10))){j++;return c[parseInt(i,10)]}else{var a=c[j],k=a.length;while(k--){if(i===a[k].nm){return a[k].v;break}}j++}})}});$.jgrid.extend({groupingSetup:function(){return this.each(function(){var a=this,grp=a.p.groupingView;if(grp!==null&&((typeof grp==='object')||$.isFunction(grp))){if(!grp.groupField.length){a.p.grouping=false}else{if(typeof(grp.visibiltyOnNextGrouping)==='undefined'){grp.visibiltyOnNextGrouping=[]}grp.lastvalues=[];grp.groups=[];grp.counters=[];for(var i=0;i<grp.groupField.length;i++){if(!grp.groupOrder[i]){grp.groupOrder[i]='asc'}if(!grp.groupText[i]){grp.groupText[i]='{0}'}if(typeof(grp.groupColumnShow[i])!=='boolean'){grp.groupColumnShow[i]=true}if(typeof(grp.groupSummary[i])!=='boolean'){grp.groupSummary[i]=false}if(grp.groupColumnShow[i]===true){grp.visibiltyOnNextGrouping[i]=true;$(a).jqGrid('showCol',grp.groupField[i])}else{grp.visibiltyOnNextGrouping[i]=$("#"+$.jgrid.jqID(a.p.id+"_"+grp.groupField[i])).is(":visible");$(a).jqGrid('hideCol',grp.groupField[i])}}grp.summary=[];var b=a.p.colModel;for(var j=0,cml=b.length;j<cml;j++){if(b[j].summaryType){grp.summary.push({nm:b[j].name,st:b[j].summaryType,v:'',sr:b[j].summaryRound,srt:b[j].summaryRoundType||'round'})}}}}else{a.p.grouping=false}})},groupingPrepare:function(c,d,e,f){this.each(function(){var a=this.p.groupingView,$t=this;var b=a.groupField.length,fieldName,v,changed=0;for(var i=0;i<b;i++){fieldName=a.groupField[i];v=e[fieldName];if(v!==undefined){if(f===0){a.groups.push({idx:i,dataIndex:fieldName,value:v,startRow:f,cnt:1,summary:[]});a.lastvalues[i]=v;a.counters[i]={cnt:1,pos:a.groups.length-1,summary:$.extend(true,[],a.summary)};$.each(a.counters[i].summary,function(){if($.isFunction(this.st)){this.v=this.st.call($t,this.v,this.nm,e)}else{this.v=$($t).jqGrid('groupingCalculations.handler',this.st,this.v,this.nm,this.sr,this.srt,e)}});a.groups[a.counters[i].pos].summary=a.counters[i].summary}else{if((typeof(v)!=="object"&&(a.lastvalues[i]!==v))){a.groups.push({idx:i,dataIndex:fieldName,value:v,startRow:f,cnt:1,summary:[]});a.lastvalues[i]=v;changed=1;a.counters[i]={cnt:1,pos:a.groups.length-1,summary:$.extend(true,[],a.summary)};$.each(a.counters[i].summary,function(){if($.isFunction(this.st)){this.v=this.st.call($t,this.v,this.nm,e)}else{this.v=$($t).jqGrid('groupingCalculations.handler',this.st,this.v,this.nm,this.sr,this.srt,e)}});a.groups[a.counters[i].pos].summary=a.counters[i].summary}else{if(changed===1){a.groups.push({idx:i,dataIndex:fieldName,value:v,startRow:f,cnt:1,summary:[]});a.lastvalues[i]=v;a.counters[i]={cnt:1,pos:a.groups.length-1,summary:$.extend(true,[],a.summary)};$.each(a.counters[i].summary,function(){if($.isFunction(this.st)){this.v=this.st.call($t,this.v,this.nm,e)}else{this.v=$($t).jqGrid('groupingCalculations.handler',this.st,this.v,this.nm,this.sr,this.srt,e)}});a.groups[a.counters[i].pos].summary=a.counters[i].summary}else{a.counters[i].cnt+=1;a.groups[a.counters[i].pos].cnt=a.counters[i].cnt;$.each(a.counters[i].summary,function(){if($.isFunction(this.st)){this.v=this.st.call($t,this.v,this.nm,e)}else{this.v=$($t).jqGrid('groupingCalculations.handler',this.st,this.v,this.nm,this.sr,this.srt,e)}});a.groups[a.counters[i].pos].summary=a.counters[i].summary}}}}}d.push(c)});return d},groupingToggle:function(c){this.each(function(){var a=this,grp=a.p.groupingView,strpos=c.split('_'),num=parseInt(strpos[strpos.length-2],10);strpos.splice(strpos.length-2,2);var b=strpos.join("_"),minus=grp.minusicon,plus=grp.plusicon,tar=$("#"+$.jgrid.jqID(c)),r=tar.length?tar[0].nextSibling:null,tarspan=$("#"+$.jgrid.jqID(c)+" span."+"tree-wrap-"+a.p.direction),collapsed=false;if(tarspan.hasClass(minus)){if(grp.showSummaryOnHide){if(r){while(r){if($(r).hasClass('jqfoot')){break}$(r).hide();r=r.nextSibling}}}else{if(r){while(r){if($(r).hasClass(b+"_"+String(num))||$(r).hasClass(b+"_"+String(num-1))){break}$(r).hide();r=r.nextSibling}}}tarspan.removeClass(minus).addClass(plus);collapsed=true}else{if(r){while(r){if($(r).hasClass(b+"_"+String(num))||$(r).hasClass(b+"_"+String(num-1))){break}$(r).show();r=r.nextSibling}}tarspan.removeClass(plus).addClass(minus)}$(a).triggerHandler("jqGridGroupingClickGroup",[c,collapsed]);if($.isFunction(a.p.onClickGroup)){a.p.onClickGroup.call(a,c,collapsed)}});return false},groupingRender:function(p,q){return this.each(function(){var l=this,grp=l.p.groupingView,str="",icon="",hid,clid,pmrtl=grp.groupCollapse?grp.plusicon:grp.minusicon,gv,cp=[],ii,len=grp.groupField.length;pmrtl+=" tree-wrap-"+l.p.direction;ii=0;$.each(l.p.colModel,function(i,n){for(var a=0;a<len;a++){if(grp.groupField[a]===n.name){cp[a]=i;break}}});var m=0;function findGroupIdx(a,b,c){if(b===0){return c[a]}else{var d=c[a].idx;if(d===0){return c[a]}for(var i=a;i>=0;i--){if(c[i].idx===d-b){return c[i]}}}}var o=grp.groupSummary;o.reverse();$.each(grp.groups,function(i,n){m++;clid=l.p.id+"ghead_"+n.idx;hid=clid+"_"+i;icon="<span style='cursor:pointer;' class='ui-icon "+pmrtl+"' onclick=\"jQuery('#"+$.jgrid.jqID(l.p.id)+"').jqGrid('groupingToggle','"+hid+"');return false;\"></span>";try{gv=l.formatter(hid,n.value,cp[n.idx],n.value)}catch(egv){gv=n.value}str+="<tr id=\""+hid+"\" role=\"row\" class= \"ui-widget-content jqgroup ui-row-"+l.p.direction+" "+clid+"\"><td style=\"padding-left:"+(n.idx*12)+"px;"+"\" colspan=\""+q+"\">"+icon+$.jgrid.template(grp.groupText[n.idx],gv,n.cnt,n.summary)+"</td></tr>";var a=len-1===n.idx;if(a){var b=grp.groups[i+1];var c=b!==undefined?grp.groups[i+1].startRow:p.length;for(var d=n.startRow;d<c;d++){str+=p[d].join('')}var e;if(b!==undefined){for(e=0;e<grp.groupField.length;e++){if(b.dataIndex===grp.groupField[e]){break}}m=grp.groupField.length-e}for(var f=0;f<m;f++){if(!o[f]){continue}var g="";if(grp.groupCollapse&&!grp.showSummaryOnHide){g=" style=\"display:none;\""}str+="<tr"+g+" role=\"row\" class=\"ui-widget-content jqfoot ui-row-"+l.p.direction+"\">";var h=findGroupIdx(i,f,grp.groups),cm=l.p.colModel,vv,grlen=h.cnt;for(var k=0;k<q;k++){var j="<td "+l.formatCol(k,1,'')+">&#160;</td>",tplfld="{0}";$.each(h.summary,function(){if(this.nm===cm[k].name){if(cm[k].summaryTpl){tplfld=cm[k].summaryTpl}if(this.st.toLowerCase()==='avg'){if(this.v&&grlen>0){this.v=(this.v/grlen)}}try{vv=l.formatter('',this.v,k,this)}catch(ef){vv=this.v}j="<td "+l.formatCol(k,1,'')+">"+$.jgrid.format(tplfld,vv)+"</td>";return false}});str+=j}str+="</tr>"}m=e}});$("#"+$.jgrid.jqID(l.p.id)+" tbody:first").append(str);str=null})},groupingGroupBy:function(c,d){return this.each(function(){var a=this;if(typeof(c)==="string"){c=[c]}var b=a.p.groupingView;a.p.grouping=true;if(typeof b.visibiltyOnNextGrouping==="undefined"){b.visibiltyOnNextGrouping=[]}var i;for(i=0;i<b.groupField.length;i++){if(!b.groupColumnShow[i]&&b.visibiltyOnNextGrouping[i]){$(a).jqGrid('showCol',b.groupField[i])}}for(i=0;i<c.length;i++){b.visibiltyOnNextGrouping[i]=$("#"+$.jgrid.jqID(a.p.id)+"_"+$.jgrid.jqID(c[i])).is(":visible")}a.p.groupingView=$.extend(a.p.groupingView,d||{});b.groupField=c;$(a).trigger("reloadGrid")})},groupingRemove:function(c){return this.each(function(){var a=this;if(typeof(c)==='undefined'){c=true}a.p.grouping=false;if(c===true){var b=a.p.groupingView;for(var i=0;i<b.groupField.length;i++){if(!b.groupColumnShow[i]&&b.visibiltyOnNextGrouping[i]){$(a).jqGrid('showCol',b.groupField)}}$("tr.jqgroup, tr.jqfoot","#"+$.jgrid.jqID(a.p.id)+" tbody:first").remove();$("tr.jqgrow:hidden","#"+$.jgrid.jqID(a.p.id)+" tbody:first").show()}else{$(a).trigger("reloadGrid")}})},groupingCalculations:{handler:function(a,v,b,c,d,e){var f={sum:function(){return parseFloat(v||0)+parseFloat((e[b]||0))},min:function(){if(v===""){return parseFloat(e[b]||0)}return Math.min(parseFloat(v),parseFloat(e[b]||0))},max:function(){if(v===""){return parseFloat(e[b]||0)}return Math.max(parseFloat(v),parseFloat(e[b]||0))},count:function(){if(v===""){v=0}if(e.hasOwnProperty(b)){return v+1}else{return 0}},avg:function(){return f.sum()}};if(!f[a]){throw("jqGrid Grouping No such method: "+a);}var g=f[a]();if(c!=null){if(d=='fixed')g=g.toFixed(c);else{var h=Math.pow(10,c);g=Math.round(g*h)/h}}return g}}})})(jQuery);
