/**
 * jqGrid extension for SubGrid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/
"use strict";
;(function($){$.jgrid.extend({setSubGrid:function(){return this.each(function(){var a=this,cm,suboptions={plusicon:"ui-icon-plus",minusicon:"ui-icon-minus",openicon:"ui-icon-carat-1-sw",expandOnLoad:false,delayOnLoad:50,selectOnExpand:false,reloadOnExpand:true};a.p.subGridOptions=$.extend(suboptions,a.p.subGridOptions||{});a.p.colNames.unshift("");a.p.colModel.unshift({name:'subgrid',width:$.browser.safari?a.p.subGridWidth+a.p.cellLayout:a.p.subGridWidth,sortable:false,resizable:false,hidedlg:true,search:false,fixed:true});cm=a.p.subGridModel;if(cm[0]){cm[0].align=$.extend([],cm[0].align||[]);for(var i=0;i<cm[0].name.length;i++){cm[0].align[i]=cm[0].align[i]||'left'}}})},addSubGridCell:function(a,b){var c='',ic,sid;this.each(function(){c=this.formatCol(a,b);sid=this.p.id;ic=this.p.subGridOptions.plusicon});return"<td role=\"gridcell\" aria-describedby=\""+sid+"_subgrid\" class=\"ui-sgcollapsed sgcollapsed\" "+c+"><a href='javascript:void(0);'><span class='ui-icon "+ic+"'></span></a></td>"},addSubGrid:function(o,p){return this.each(function(){var e=this;if(!e.grid){return}var g=function(a,b,c){var d=$("<td align='"+e.p.subGridModel[0].align[c]+"'></td>").html(b);$(a).append(d)};var h=function(a,b){var c,i,sgmap,dummy=$("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),trdiv=$("<tr></tr>");for(i=0;i<e.p.subGridModel[0].name.length;i++){c=$("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+e.p.direction+"'></th>");$(c).html(e.p.subGridModel[0].name[i]);$(c).width(e.p.subGridModel[0].width[i]);$(trdiv).append(c)}$(dummy).append(trdiv);if(a){sgmap=e.p.xmlReader.subgrid;$(sgmap.root+" "+sgmap.row,a).each(function(){trdiv=$("<tr class='ui-widget-content ui-subtblcell'></tr>");if(sgmap.repeatitems===true){$(sgmap.cell,this).each(function(i){g(trdiv,$(this).text()||'&#160;',i)})}else{var f=e.p.subGridModel[0].mapping||e.p.subGridModel[0].name;if(f){for(i=0;i<f.length;i++){g(trdiv,$(f[i],this).text()||'&#160;',i)}}}$(dummy).append(trdiv)})}var d=$("table:first",e.grid.bDiv).attr("id")+"_";$("#"+$.jgrid.jqID(d+b)).append(dummy);e.grid.hDiv.loading=false;$("#load_"+$.jgrid.jqID(e.p.id)).hide();return false};var k=function(a,b){var c,result,i,cur,sgmap,j,dummy=$("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),trdiv=$("<tr></tr>");for(i=0;i<e.p.subGridModel[0].name.length;i++){c=$("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+e.p.direction+"'></th>");$(c).html(e.p.subGridModel[0].name[i]);$(c).width(e.p.subGridModel[0].width[i]);$(trdiv).append(c)}$(dummy).append(trdiv);if(a){sgmap=e.p.jsonReader.subgrid;result=a[sgmap.root];if(typeof result!=='undefined'){for(i=0;i<result.length;i++){cur=result[i];trdiv=$("<tr class='ui-widget-content ui-subtblcell'></tr>");if(sgmap.repeatitems===true){if(sgmap.cell){cur=cur[sgmap.cell]}for(j=0;j<cur.length;j++){g(trdiv,cur[j]||'&#160;',j)}}else{var f=e.p.subGridModel[0].mapping||e.p.subGridModel[0].name;if(f.length){for(j=0;j<f.length;j++){g(trdiv,cur[f[j]]||'&#160;',j)}}}$(dummy).append(trdiv)}}}var d=$("table:first",e.grid.bDiv).attr("id")+"_";$("#"+$.jgrid.jqID(d+b)).append(dummy);e.grid.hDiv.loading=false;$("#load_"+$.jgrid.jqID(e.p.id)).hide();return false};var l=function(b){var c,dp,i,j;c=$(b).attr("id");dp={nd_:(new Date().getTime())};dp[e.p.prmNames.subgridid]=c;if(!e.p.subGridModel[0]){return false}if(e.p.subGridModel[0].params){for(j=0;j<e.p.subGridModel[0].params.length;j++){for(i=0;i<e.p.colModel.length;i++){if(e.p.colModel[i].name===e.p.subGridModel[0].params[j]){dp[e.p.colModel[i].name]=$("td:eq("+i+")",b).text().replace(/\&#160\;/ig,'')}}}}if(!e.grid.hDiv.loading){e.grid.hDiv.loading=true;$("#load_"+$.jgrid.jqID(e.p.id)).show();if(!e.p.subgridtype){e.p.subgridtype=e.p.datatype}if($.isFunction(e.p.subgridtype)){e.p.subgridtype.call(e,dp)}else{e.p.subgridtype=e.p.subgridtype.toLowerCase()}switch(e.p.subgridtype){case"xml":case"json":$.ajax($.extend({type:e.p.mtype,url:e.p.subGridUrl,dataType:e.p.subgridtype,data:$.isFunction(e.p.serializeSubGridData)?e.p.serializeSubGridData.call(e,dp):dp,complete:function(a){if(e.p.subgridtype==="xml"){h(a.responseXML,c)}else{k($.jgrid.parse(a.responseText),c)}a=null}},$.jgrid.ajaxOptions,e.p.ajaxSubgridOptions||{}));break}}return false};var m,pID,atd,nhc=0,bfsc,r;$.each(e.p.colModel,function(){if(this.hidden===true||this.name==='rn'||this.name==='cb'){nhc++}});var n=e.rows.length,i=1;if(p!==undefined&&p>0){i=p;n=p+1}while(i<n){if($(e.rows[i]).hasClass('jqgrow')){$(e.rows[i].cells[o]).bind('click',function(){var a=$(this).parent("tr")[0];r=a.nextSibling;if($(this).hasClass("sgcollapsed")){pID=e.p.id;m=a.id;if(e.p.subGridOptions.reloadOnExpand===true||(e.p.subGridOptions.reloadOnExpand===false&&!$(r).hasClass('ui-subgrid'))){atd=o>=1?"<td colspan='"+o+"'>&#160;</td>":"";bfsc=$(e).triggerHandler("jqGridSubGridBeforeExpand",[pID+"_"+m,m]);bfsc=(bfsc===false||bfsc==='stop')?false:true;if(bfsc&&$.isFunction(e.p.subGridBeforeExpand)){bfsc=e.p.subGridBeforeExpand.call(e,pID+"_"+m,m)}if(bfsc===false){return false}$(a).after("<tr role='row' class='ui-subgrid'>"+atd+"<td class='ui-widget-content subgrid-cell'><span class='ui-icon "+e.p.subGridOptions.openicon+"'></span></td><td colspan='"+parseInt(e.p.colNames.length-1-nhc,10)+"' class='ui-widget-content subgrid-data'><div id="+pID+"_"+m+" class='tablediv'></div></td></tr>");$(e).triggerHandler("jqGridSubGridRowExpanded",[pID+"_"+m,m]);if($.isFunction(e.p.subGridRowExpanded)){e.p.subGridRowExpanded.call(e,pID+"_"+m,m)}else{l(a)}}else{$(r).show()}$(this).html("<a href='javascript:void(0);'><span class='ui-icon "+e.p.subGridOptions.minusicon+"'></span></a>").removeClass("sgcollapsed").addClass("sgexpanded");if(e.p.subGridOptions.selectOnExpand){$(e).jqGrid('setSelection',m)}}else if($(this).hasClass("sgexpanded")){bfsc=$(e).triggerHandler("jqGridSubGridRowColapsed",[pID+"_"+m,m]);bfsc=(bfsc===false||bfsc==='stop')?false:true;if(bfsc&&$.isFunction(e.p.subGridRowColapsed)){m=a.id;bfsc=e.p.subGridRowColapsed.call(e,pID+"_"+m,m)}if(bfsc===false){return false}if(e.p.subGridOptions.reloadOnExpand===true){$(r).remove(".ui-subgrid")}else if($(r).hasClass('ui-subgrid')){$(r).hide()}$(this).html("<a href='javascript:void(0);'><span class='ui-icon "+e.p.subGridOptions.plusicon+"'></span></a>").removeClass("sgexpanded").addClass("sgcollapsed")}return false})}i++}if(e.p.subGridOptions.expandOnLoad===true){$(e.rows).filter('.jqgrow').each(function(a,b){$(b.cells[0]).click()})}e.subGridXml=function(a,b){h(a,b)};e.subGridJson=function(a,b){k(a,b)}})},expandSubGridRow:function(d){return this.each(function(){var a=this;if(!a.grid&&!d){return}if(a.p.subGrid===true){var b=$(this).jqGrid("getInd",d,true);if(b){var c=$("td.sgcollapsed",b)[0];if(c){$(c).trigger("click")}}}})},collapseSubGridRow:function(d){return this.each(function(){var a=this;if(!a.grid&&!d){return}if(a.p.subGrid===true){var b=$(this).jqGrid("getInd",d,true);if(b){var c=$("td.sgexpanded",b)[0];if(c){$(c).trigger("click")}}}})},toggleSubGridRow:function(d){return this.each(function(){var a=this;if(!a.grid&&!d){return}if(a.p.subGrid===true){var b=$(this).jqGrid("getInd",d,true);if(b){var c=$("td.sgcollapsed",b)[0];if(c){$(c).trigger("click")}else{c=$("td.sgexpanded",b)[0];if(c){$(c).trigger("click")}}}}})}})})(jQuery);
