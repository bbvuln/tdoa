/*
**
 * jqGrid extension for cellediting Grid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/ 
/**
 * all events and options here are aded anonynous and not in the base grid
 * since the array is to big. Here is the order of execution.
 * From this point we use jQuery isFunction
 * formatCell
 * beforeEditCell,
 * onSelectCell (used only for noneditable cels)
 * afterEditCell,
 * beforeSaveCell, (called before validation of values if any)
 * beforeSubmitCell (if cellsubmit remote (ajax))
 * afterSubmitCell(if cellsubmit remote (ajax)),
 * afterSaveCell,
 * errorCell,
 * serializeCellData - new
 * Options
 * cellsubmit (remote,clientArray) (added in grid options)
 * cellurl
 * ajaxCellOptions
* */
"use strict";
;(function($){$.jgrid.extend({editCell:function(f,g,h){return this.each(function(){var a=this,nm,tmp,cc,cm;if(!a.grid||a.p.cellEdit!==true){return}g=parseInt(g,10);a.p.selrow=a.rows[f].id;if(!a.p.knv){$(a).jqGrid("GridNav")}if(a.p.savedRow.length>0){if(h===true){if(f==a.p.iRow&&g==a.p.iCol){return}}$(a).jqGrid("saveCell",a.p.savedRow[0].id,a.p.savedRow[0].ic)}else{window.setTimeout(function(){$("#"+$.jgrid.jqID(a.p.knv)).attr("tabindex","-1").focus()},0)}cm=a.p.colModel[g];nm=cm.name;if(nm=='subgrid'||nm=='cb'||nm=='rn'){return}cc=$("td:eq("+g+")",a.rows[f]);if(cm.editable===true&&h===true&&!cc.hasClass("not-editable-cell")){if(parseInt(a.p.iCol,10)>=0&&parseInt(a.p.iRow,10)>=0){$("td:eq("+a.p.iCol+")",a.rows[a.p.iRow]).removeClass("edit-cell ui-state-highlight");$(a.rows[a.p.iRow]).removeClass("selected-row ui-state-hover")}$(cc).addClass("edit-cell ui-state-highlight");$(a.rows[f]).addClass("selected-row ui-state-hover");try{tmp=$.unformat.call(a,cc,{rowId:a.rows[f].id,colModel:cm},g)}catch(_){tmp=(cm.edittype&&cm.edittype=='textarea')?$(cc).text():$(cc).html()}if(a.p.autoencode){tmp=$.jgrid.htmlDecode(tmp)}if(!cm.edittype){cm.edittype="text"}a.p.savedRow.push({id:f,ic:g,name:nm,v:tmp});if(tmp==="&nbsp;"||tmp==="&#160;"||(tmp.length===1&&tmp.charCodeAt(0)===160)){tmp=''}if($.isFunction(a.p.formatCell)){var b=a.p.formatCell.call(a,a.rows[f].id,nm,tmp,f,g);if(b!==undefined){tmp=b}}var c=$.extend({},cm.editoptions||{},{id:f+"_"+nm,name:nm});var d=$.jgrid.createEl.call(a,cm.edittype,c,tmp,true,$.extend({},$.jgrid.ajaxOptions,a.p.ajaxSelectOptions||{}));$(a).triggerHandler("jqGridBeforeEditCell",[a.rows[f].id,nm,tmp,f,g]);if($.isFunction(a.p.beforeEditCell)){a.p.beforeEditCell.call(a,a.rows[f].id,nm,tmp,f,g)}$(cc).html("").append(d).attr("tabindex","0");window.setTimeout(function(){$(d).focus()},0);$("input, select, textarea",cc).bind("keydown",function(e){if(e.keyCode===27){if($("input.hasDatepicker",cc).length>0){if($(".ui-datepicker").is(":hidden")){$(a).jqGrid("restoreCell",f,g)}else{$("input.hasDatepicker",cc).datepicker('hide')}}else{$(a).jqGrid("restoreCell",f,g)}}if(e.keyCode===13){$(a).jqGrid("saveCell",f,g);return false}if(e.keyCode===9){if(!a.grid.hDiv.loading){if(e.shiftKey){$(a).jqGrid("prevCell",f,g)}else{$(a).jqGrid("nextCell",f,g)}}else{return false}}e.stopPropagation()});$(a).triggerHandler("jqGridAfterEditCell",[a.rows[f].id,nm,tmp,f,g]);if($.isFunction(a.p.afterEditCell)){a.p.afterEditCell.call(a,a.rows[f].id,nm,tmp,f,g)}}else{if(parseInt(a.p.iCol,10)>=0&&parseInt(a.p.iRow,10)>=0){$("td:eq("+a.p.iCol+")",a.rows[a.p.iRow]).removeClass("edit-cell ui-state-highlight");$(a.rows[a.p.iRow]).removeClass("selected-row ui-state-hover")}cc.addClass("edit-cell ui-state-highlight");$(a.rows[f]).addClass("selected-row ui-state-hover");tmp=cc.html().replace(/\&#160\;/ig,'');$(a).triggerHandler("jqGridSelectCell",[a.rows[f].id,nm,tmp,f,g]);if($.isFunction(a.p.onSelectCell)){a.p.onSelectCell.call(a,a.rows[f].id,nm,tmp,f,g)}}a.p.iCol=g;a.p.iRow=f})},saveCell:function(p,q){return this.each(function(){var d=this,fr;if(!d.grid||d.p.cellEdit!==true){return}if(d.p.savedRow.length>=1){fr=0}else{fr=null}if(fr!==null){var f=$("td:eq("+q+")",d.rows[p]),v,v2,cm=d.p.colModel[q],nm=cm.name,nmjq=$.jgrid.jqID(nm);switch(cm.edittype){case"select":if(!cm.editoptions.multiple){v=$("#"+p+"_"+nmjq+" option:selected",d.rows[p]).val();v2=$("#"+p+"_"+nmjq+" option:selected",d.rows[p]).text()}else{var g=$("#"+p+"_"+nmjq,d.rows[p]),selectedText=[];v=$(g).val();if(v){v.join(",")}else{v=""}$("option:selected",g).each(function(i,a){selectedText[i]=$(a).text()});v2=selectedText.join(",")}if(cm.formatter){v2=v}break;case"checkbox":var h=["Yes","No"];if(cm.editoptions){h=cm.editoptions.value.split(":")}v=$("#"+p+"_"+nmjq,d.rows[p]).is(":checked")?h[0]:h[1];v2=v;break;case"password":case"text":case"textarea":case"button":v=$("#"+p+"_"+nmjq,d.rows[p]).val();v2=v;break;case'custom':try{if(cm.editoptions&&$.isFunction(cm.editoptions.custom_value)){v=cm.editoptions.custom_value.call(d,$(".customelement",f),'get');if(v===undefined){throw"e2";}else{v2=v}}else{throw"e1";}}catch(e){if(e=="e1"){$.jgrid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+$.jgrid.edit.msg.nodefined,jQuery.jgrid.edit.bClose)}if(e=="e2"){$.jgrid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+$.jgrid.edit.msg.novalue,jQuery.jgrid.edit.bClose)}else{$.jgrid.info_dialog(jQuery.jgrid.errors.errcap,e.message,jQuery.jgrid.edit.bClose)}}break}if(v2!==d.p.savedRow[fr].v){var j=$(d).triggerHandler("jqGridBeforeSaveCell",[d.rows[p].id,nm,v,p,q]);if(j){v=j;v2=j}if($.isFunction(d.p.beforeSaveCell)){var k=d.p.beforeSaveCell.call(d,d.rows[p].id,nm,v,p,q);if(k){v=k;v2=k}}var l=$.jgrid.checkValues(v,q,d);if(l[0]===true){var m=$(d).triggerHandler("jqGridBeforeSubmitCell",[d.rows[p].id,nm,v,p,q])||{};if($.isFunction(d.p.beforeSubmitCell)){m=d.p.beforeSubmitCell.call(d,d.rows[p].id,nm,v,p,q);if(!m){m={}}}if($("input.hasDatepicker",f).length>0){$("input.hasDatepicker",f).datepicker('hide')}if(d.p.cellsubmit=='remote'){if(d.p.cellurl){var n={};if(d.p.autoencode){v=$.jgrid.htmlEncode(v)}n[nm]=v;var o,oper,opers;opers=d.p.prmNames;o=opers.id;oper=opers.oper;n[o]=$.jgrid.stripPref(d.p.idPrefix,d.rows[p].id);n[oper]=opers.editoper;n=$.extend(m,n);$("#lui_"+$.jgrid.jqID(d.p.id)).show();d.grid.hDiv.loading=true;$.ajax($.extend({url:d.p.cellurl,data:$.isFunction(d.p.serializeCellData)?d.p.serializeCellData.call(d,n):n,type:"POST",complete:function(a,b){$("#lui_"+d.p.id).hide();d.grid.hDiv.loading=false;if(b=='success'){var c=$(d).triggerHandler("jqGridAfterSubmitCell",[d,a,n.id,nm,v,p,q])||[true,''];if(c[0]===true&&$.isFunction(d.p.afterSubmitCell)){c=d.p.afterSubmitCell.call(d,a,n.id,nm,v,p,q)}if(c[0]===true){$(f).empty();$(d).jqGrid("setCell",d.rows[p].id,q,v2,false,false,true);$(f).addClass("dirty-cell");$(d.rows[p]).addClass("edited");$(d).triggerHandler("jqGridAfterSaveCell",[d.rows[p].id,nm,v,p,q]);if($.isFunction(d.p.afterSaveCell)){d.p.afterSaveCell.call(d,d.rows[p].id,nm,v,p,q)}d.p.savedRow.splice(0,1)}else{$.jgrid.info_dialog($.jgrid.errors.errcap,c[1],$.jgrid.edit.bClose);$(d).jqGrid("restoreCell",p,q)}}},error:function(a,b,c){$("#lui_"+$.jgrid.jqID(d.p.id)).hide();d.grid.hDiv.loading=false;$(d).triggerHandler("jqGridErrorCell",[a,b,c]);if($.isFunction(d.p.errorCell)){d.p.errorCell.call(d,a,b,c);$(d).jqGrid("restoreCell",p,q)}else{$.jgrid.info_dialog($.jgrid.errors.errcap,a.status+" : "+a.statusText+"<br/>"+b,$.jgrid.edit.bClose);$(d).jqGrid("restoreCell",p,q)}}},$.jgrid.ajaxOptions,d.p.ajaxCellOptions||{}))}else{try{$.jgrid.info_dialog($.jgrid.errors.errcap,$.jgrid.errors.nourl,$.jgrid.edit.bClose);$(d).jqGrid("restoreCell",p,q)}catch(e){}}}if(d.p.cellsubmit=='clientArray'){$(f).empty();$(d).jqGrid("setCell",d.rows[p].id,q,v2,false,false,true);$(f).addClass("dirty-cell");$(d.rows[p]).addClass("edited");$(d).triggerHandler("jqGridAfterSaveCell",[d.rows[p].id,nm,v,p,q]);if($.isFunction(d.p.afterSaveCell)){d.p.afterSaveCell.call(d,d.rows[p].id,nm,v,p,q)}d.p.savedRow.splice(0,1)}}else{try{window.setTimeout(function(){$.jgrid.info_dialog($.jgrid.errors.errcap,v+" "+l[1],$.jgrid.edit.bClose)},100);$(d).jqGrid("restoreCell",p,q)}catch(e){}}}else{$(d).jqGrid("restoreCell",p,q)}}if($.browser.opera){$("#"+$.jgrid.jqID(d.p.knv)).attr("tabindex","-1").focus()}else{window.setTimeout(function(){$("#"+$.jgrid.jqID(d.p.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(c,d){return this.each(function(){var a=this,fr;if(!a.grid||a.p.cellEdit!==true){return}if(a.p.savedRow.length>=1){fr=0}else{fr=null}if(fr!==null){var b=$("td:eq("+d+")",a.rows[c]);if($.isFunction($.fn.datepicker)){try{$("input.hasDatepicker",b).datepicker('hide')}catch(e){}}$(b).empty().attr("tabindex","-1");$(a).jqGrid("setCell",a.rows[c].id,d,a.p.savedRow[fr].v,false,false,true);$(a).triggerHandler("jqGridAfterRestoreCell",[a.rows[c].id,a.p.savedRow[fr].v,c,d]);if($.isFunction(a.p.afterRestoreCell)){a.p.afterRestoreCell.call(a,a.rows[c].id,a.p.savedRow[fr].v,c,d)}a.p.savedRow.splice(0,1)}window.setTimeout(function(){$("#"+a.p.knv).attr("tabindex","-1").focus()},0)})},nextCell:function(b,c){return this.each(function(){var a=this,nCol=false;if(!a.grid||a.p.cellEdit!==true){return}for(var i=c+1;i<a.p.colModel.length;i++){if(a.p.colModel[i].editable===true){nCol=i;break}}if(nCol!==false){$(a).jqGrid("editCell",b,nCol,true)}else{if(a.p.savedRow.length>0){$(a).jqGrid("saveCell",b,c)}}})},prevCell:function(b,c){return this.each(function(){var a=this,nCol=false;if(!a.grid||a.p.cellEdit!==true){return}for(var i=c-1;i>=0;i--){if(a.p.colModel[i].editable===true){nCol=i;break}}if(nCol!==false){$(a).jqGrid("editCell",b,nCol,true)}else{if(a.p.savedRow.length>0){$(a).jqGrid("saveCell",b,c)}}})},GridNav:function(){return this.each(function(){var f=this;if(!f.grid||f.p.cellEdit!==true){return}f.p.knv=f.p.id+"_kn";var g=$("<span style='width:0px;height:0px;background-color:black;' tabindex='0'><span tabindex='-1' style='width:0px;height:0px;background-color:grey' id='"+f.p.knv+"'></span></span>"),i,kdir;function scrollGrid(a,b,c){if(c.substr(0,1)=='v'){var d=$(f.grid.bDiv)[0].clientHeight,st=$(f.grid.bDiv)[0].scrollTop,nROT=f.rows[a].offsetTop+f.rows[a].clientHeight,pROT=f.rows[a].offsetTop;if(c=='vd'){if(nROT>=d){$(f.grid.bDiv)[0].scrollTop=$(f.grid.bDiv)[0].scrollTop+f.rows[a].clientHeight}}if(c=='vu'){if(pROT<st){$(f.grid.bDiv)[0].scrollTop=$(f.grid.bDiv)[0].scrollTop-f.rows[a].clientHeight}}}if(c=='h'){var e=$(f.grid.bDiv)[0].clientWidth,sl=$(f.grid.bDiv)[0].scrollLeft,nCOL=f.rows[a].cells[b].offsetLeft+f.rows[a].cells[b].clientWidth,pCOL=f.rows[a].cells[b].offsetLeft;if(nCOL>=e+parseInt(sl,10)){$(f.grid.bDiv)[0].scrollLeft=$(f.grid.bDiv)[0].scrollLeft+f.rows[a].cells[b].clientWidth}else if(pCOL<sl){$(f.grid.bDiv)[0].scrollLeft=$(f.grid.bDiv)[0].scrollLeft-f.rows[a].cells[b].clientWidth}}}function findNextVisible(a,b){var c,i;if(b=='lft'){c=a+1;for(i=a;i>=0;i--){if(f.p.colModel[i].hidden!==true){c=i;break}}}if(b=='rgt'){c=a-1;for(i=a;i<f.p.colModel.length;i++){if(f.p.colModel[i].hidden!==true){c=i;break}}}return c}$(g).insertBefore(f.grid.cDiv);$("#"+f.p.knv).focus().keydown(function(e){kdir=e.keyCode;if(f.p.direction=="rtl"){if(kdir===37){kdir=39}else if(kdir===39){kdir=37}}switch(kdir){case 38:if(f.p.iRow-1>0){scrollGrid(f.p.iRow-1,f.p.iCol,'vu');$(f).jqGrid("editCell",f.p.iRow-1,f.p.iCol,false)}break;case 40:if(f.p.iRow+1<=f.rows.length-1){scrollGrid(f.p.iRow+1,f.p.iCol,'vd');$(f).jqGrid("editCell",f.p.iRow+1,f.p.iCol,false)}break;case 37:if(f.p.iCol-1>=0){i=findNextVisible(f.p.iCol-1,'lft');scrollGrid(f.p.iRow,i,'h');$(f).jqGrid("editCell",f.p.iRow,i,false)}break;case 39:if(f.p.iCol+1<=f.p.colModel.length-1){i=findNextVisible(f.p.iCol+1,'rgt');scrollGrid(f.p.iRow,i,'h');$(f).jqGrid("editCell",f.p.iRow,i,false)}break;case 13:if(parseInt(f.p.iCol,10)>=0&&parseInt(f.p.iRow,10)>=0){$(f).jqGrid("editCell",f.p.iRow,f.p.iCol,true)}break;default:return true}return false})})},getChangedCells:function(c){var d=[];if(!c){c='all'}this.each(function(){var b=this,nm;if(!b.grid||b.p.cellEdit!==true){return}$(b.rows).each(function(j){var a={};if($(this).hasClass("edited")){$('td',this).each(function(i){nm=b.p.colModel[i].name;if(nm!=='cb'&&nm!=='subgrid'){if(c=='dirty'){if($(this).hasClass('dirty-cell')){try{a[nm]=$.unformat.call(b,this,{rowId:b.rows[j].id,colModel:b.p.colModel[i]},i)}catch(e){a[nm]=$.jgrid.htmlDecode($(this).html())}}}else{try{a[nm]=$.unformat.call(b,this,{rowId:b.rows[j].id,colModel:b.p.colModel[i]},i)}catch(e){a[nm]=$.jgrid.htmlDecode($(this).html())}}}});a.id=this.id;d.push(a)}})});return d}})})(jQuery);