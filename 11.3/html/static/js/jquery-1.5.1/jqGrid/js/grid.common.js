/*
 * jqGrid common function
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
*/
/*global jQuery, $ */
;(function($){$.extend($.jgrid,{showModal:function(h){h.w.show()},closeModal:function(h){h.w.hide().attr("aria-hidden","true");if(h.o){h.o.remove()}},hideModal:function(a,o){o=$.extend({jqm:true,gb:''},o||{});if(o.onClose){var b=o.onClose(a);if(typeof b=='boolean'&&!b){return}}if($.fn.jqm&&o.jqm===true){$(a).attr("aria-hidden","true").jqmHide()}else{if(o.gb!==''){try{$(".jqgrid-overlay:first",o.gb).hide()}catch(e){}}$(a).hide().attr("aria-hidden","true")}},findPos:function(a){var b=0,curtop=0;if(a.offsetParent){do{b+=a.offsetLeft;curtop+=a.offsetTop}while(a=a.offsetParent)}return[b,curtop]},createModal:function(c,d,p,f,g,h,i){var j=document.createElement('div'),rtlsup,self=this;i=$.extend({},i||{});rtlsup=$(p.gbox).attr("dir")=="rtl"?true:false;j.className="ui-widget ui-widget-content ui-corner-all ui-jqdialog";j.id=c.themodal;var k=document.createElement('div');k.className="ui-jqdialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix";k.id=c.modalhead;$(k).append("<span class='ui-jqdialog-title'>"+p.caption+"</span>");var l=$("<a href='javascript:void(0)' class='ui-jqdialog-titlebar-close ui-corner-all'></a>").hover(function(){l.addClass('ui-state-hover')},function(){l.removeClass('ui-state-hover')}).append("<span class='ui-icon ui-icon-closethick'></span>");$(k).append(l);if(rtlsup){j.dir="rtl";$(".ui-jqdialog-title",k).css("float","right");$(".ui-jqdialog-titlebar-close",k).css("left",0.3+"em")}else{j.dir="ltr";$(".ui-jqdialog-title",k).css("float","left");$(".ui-jqdialog-titlebar-close",k).css("right",0.3+"em")}var m=document.createElement('div');$(m).addClass("ui-jqdialog-content ui-widget-content").attr("id",c.modalcontent);$(m).append(d);j.appendChild(m);$(j).prepend(k);if(h===true){$('body').append(j)}else if(typeof h=="string")$(h).append(j);else{$(j).insertBefore(f)}$(j).css(i);if(typeof p.jqModal==='undefined'){p.jqModal=true}var n={};if($.fn.jqm&&p.jqModal===true){if(p.left===0&&p.top===0&&p.overlay){var o=[];o=$.jgrid.findPos(g);p.left=o[0]+4;p.top=o[1]+4}n.top=p.top+"px";n.left=p.left}else if(p.left!==0||p.top!==0){n.left=p.left;n.top=p.top+"px"}$("a.ui-jqdialog-titlebar-close",k).click(function(){var a=$("#"+$.jgrid.jqID(c.themodal)).data("onClose")||p.onClose;var b=$("#"+$.jgrid.jqID(c.themodal)).data("gbox")||p.gbox;self.hideModal("#"+$.jgrid.jqID(c.themodal),{gb:b,jqm:p.jqModal,onClose:a});return false});if(p.width===0||!p.width){p.width=300}if(p.height===0||!p.height){p.height=200}if(!p.zIndex){var q=$(f).parents("*[role=dialog]").filter(':first').css("z-index");if(q){p.zIndex=parseInt(q,10)+2}else{p.zIndex=950}}var s=0;if(rtlsup&&n.left&&!h){s=$(p.gbox).width()-(!isNaN(p.width)?parseInt(p.width,10):0)-8;n.left=parseInt(n.left,10)+parseInt(s,10)}if(n.left){n.left+="px"}$(j).css($.extend({width:isNaN(p.width)?"auto":p.width+"px",height:isNaN(p.height)?"auto":p.height+"px",zIndex:p.zIndex,overflow:'hidden'},n)).attr({tabIndex:"-1","role":"dialog","aria-labelledby":c.modalhead,"aria-hidden":"true"});if(typeof p.drag=='undefined'){p.drag=true}if(typeof p.resize=='undefined'){p.resize=true}if(p.drag){$(k).css('cursor','move');if($.fn.jqDrag){$(j).jqDrag(k)}else{try{$(j).draggable({handle:$("#"+$.jgrid.jqID(k.id))})}catch(e){}}}if(p.resize){if($.fn.jqResize){$(j).append("<div class='jqResize ui-resizable-handle ui-resizable-se ui-icon ui-icon-gripsmall-diagonal-se ui-icon-grip-diagonal-se'></div>");$("#"+$.jgrid.jqID(c.themodal)).jqResize(".jqResize",c.scrollelm?"#"+$.jgrid.jqID(c.scrollelm):false)}else{try{$(j).resizable({handles:'se, sw',alsoResize:c.scrollelm?"#"+$.jgrid.jqID(c.scrollelm):false})}catch(r){}}}if(p.closeOnEscape===true){$(j).keydown(function(e){if(e.which==27){var a=$("#"+$.jgrid.jqID(c.themodal)).data("onClose")||p.onClose;self.hideModal(this,{gb:p.gbox,jqm:p.jqModal,onClose:a})}})}},viewModal:function(a,o){o=$.extend({toTop:true,overlay:10,modal:false,overlayClass:'ui-widget-overlay',onShow:$.jgrid.showModal,onHide:$.jgrid.closeModal,gbox:'',jqm:true,jqM:true},o||{});if($.fn.jqm&&o.jqm===true){if(o.jqM){$(a).attr("aria-hidden","false").jqm(o).jqmShow()}else{$(a).attr("aria-hidden","false").jqmShow()}}else{if(o.gbox!==''){$(".jqgrid-overlay:first",o.gbox).show();$(a).data("gbox",o.gbox)}$(a).show().attr("aria-hidden","false");try{$(':input:visible',a)[0].focus()}catch(_){}}},info_dialog:function(a,b,c,d){var f={width:290,height:'auto',dataheight:'auto',drag:true,resize:false,caption:"<b>"+a+"</b>",left:250,top:170,zIndex:1000,jqModal:true,modal:false,closeOnEscape:true,align:'center',buttonalign:'center',buttons:[]};$.extend(f,d||{});var g=f.jqModal,self=this;if($.fn.jqm&&!g){g=false}var j="";if(f.buttons.length>0){for(var i=0;i<f.buttons.length;i++){if(typeof f.buttons[i].id=="undefined"){f.buttons[i].id="info_button_"+i}j+="<a href='javascript:void(0)' id='"+f.buttons[i].id+"' class='fm-button ui-state-default ui-corner-all'>"+f.buttons[i].text+"</a>"}}var k=isNaN(f.dataheight)?f.dataheight:f.dataheight+"px",cn="text-align:"+f.align+";";var l="<div id='info_id'>";l+="<div id='infocnt' style='margin:0px;padding-bottom:1em;width:100%;overflow:auto;position:relative;height:"+k+";"+cn+"'>"+b+"</div>";l+=c?"<div class='ui-widget-content ui-helper-clearfix' style='text-align:"+f.buttonalign+";padding-bottom:0.8em;padding-top:0.5em;background-image: none;border-width: 1px 0 0 0;'><a href='javascript:void(0)' id='closedialog' class='fm-button ui-state-default ui-corner-all'>"+c+"</a>"+j+"</div>":j!==""?"<div class='ui-widget-content ui-helper-clearfix' style='text-align:"+f.buttonalign+";padding-bottom:0.8em;padding-top:0.5em;background-image: none;border-width: 1px 0 0 0;'>"+j+"</div>":"";l+="</div>";try{if($("#info_dialog").attr("aria-hidden")=="false"){$.jgrid.hideModal("#info_dialog",{jqm:g})}$("#info_dialog").remove()}catch(e){}$.jgrid.createModal({themodal:'info_dialog',modalhead:'info_head',modalcontent:'info_content',scrollelm:'infocnt'},l,f,'','',true);if(j){$.each(f.buttons,function(i){$("#"+$.jgrid.jqID(this.id),"#info_id").bind('click',function(){f.buttons[i].onClick.call($("#info_dialog"));return false})})}$("#closedialog","#info_id").click(function(){self.hideModal("#info_dialog",{jqm:g});return false});$(".fm-button","#info_dialog").hover(function(){$(this).addClass('ui-state-hover')},function(){$(this).removeClass('ui-state-hover')});if($.isFunction(f.beforeOpen)){f.beforeOpen()}$.jgrid.viewModal("#info_dialog",{onHide:function(h){h.w.hide().remove();if(h.o){h.o.remove()}},modal:f.modal,jqm:g});if($.isFunction(f.afterOpen)){f.afterOpen()}try{$("#info_dialog").focus()}catch(m){}},createEl:function(g,h,j,k,l){var m="",$t=this;function bindEv(a,b){if($.isFunction(b.dataInit)){b.dataInit.call($t,a)}if(b.dataEvents){$.each(b.dataEvents,function(){if(this.data!==undefined){$(a).bind(this.type,this.data,this.fn)}else{$(a).bind(this.type,this.fn)}})}return b}function setAttributes(c,d,e){var f=['dataInit','dataEvents','dataUrl','buildSelect','sopt','searchhidden','defaultValue','attr'];if(typeof(e)!="undefined"&&$.isArray(e)){$.merge(f,e)}$.each(d,function(a,b){if($.inArray(a,f)===-1){$(c).attr(a,b)}});if(!d.hasOwnProperty('id')){$(c).attr('id',$.jgrid.randId())}}switch(g){case"textarea":m=document.createElement("textarea");if(k){if(!h.cols){$(m).css({width:"98%"})}}else if(!h.cols){h.cols=20}if(!h.rows){h.rows=2}if(j=='&nbsp;'||j=='&#160;'||(j.length==1&&j.charCodeAt(0)==160)){j=""}m.value=j;setAttributes(m,h);h=bindEv(m,h);$(m).attr({"role":"textbox","multiline":"true"});break;case"checkbox":m=document.createElement("input");m.type="checkbox";if(!h.value){var o=j.toLowerCase();if(o.search(/(false|0|no|off|undefined)/i)<0&&o!==""){m.checked=true;m.defaultChecked=true;m.value=j}else{m.value="on"}$(m).attr("offval","off")}else{var p=h.value.split(":");if(j===p[0]){m.checked=true;m.defaultChecked=true}m.value=p[0];$(m).attr("offval",p[1])}setAttributes(m,h,['value']);h=bindEv(m,h);$(m).attr("role","checkbox");break;case"select":m=document.createElement("select");m.setAttribute("role","select");var q,ovm=[];if(h.multiple===true){q=true;m.multiple="multiple";$(m).attr("aria-multiselectable","true")}else{q=false}if(typeof(h.dataUrl)!="undefined"){$.ajax($.extend({url:h.dataUrl,type:"GET",dataType:"html",context:{elem:m,options:h,vl:j},success:function(c){var a,ovm=[],m=this.elem,j=this.vl,h=$.extend({},this.options),q=h.multiple===true;if($.isFunction(h.buildSelect)){var b=h.buildSelect.call($t,c);a=$(b).html()}else{a=$(c).html()}if(a){$(m).append(a);setAttributes(m,h);h=bindEv(m,h);if(typeof h.size==='undefined'){h.size=q?3:1}if(q){ovm=j.split(",");ovm=$.map(ovm,function(n){return $.trim(n)})}else{ovm[0]=$.trim(j)}setTimeout(function(){$("option",m).each(function(i){if(i===0&&m.multiple){this.selected=false}$(this).attr("role","option");if($.inArray($.trim($(this).text()),ovm)>-1||$.inArray($.trim($(this).val()),ovm)>-1){this.selected="selected"}})},0)}}},l||{}))}else if(h.value){var i;if(typeof h.size==='undefined'){h.size=q?3:1}if(q){ovm=j.split(",");ovm=$.map(ovm,function(n){return $.trim(n)})}if(typeof h.value==='function'){h.value=h.value()}var r,sv,ov,sep=h.separator===undefined?":":h.separator,delim=h.delimiter===undefined?";":h.delimiter;if(typeof h.value==='string'){r=h.value.split(delim);for(i=0;i<r.length;i++){sv=r[i].split(sep);if(sv.length>2){sv[1]=$.map(sv,function(n,a){if(a>0){return n}}).join(sep)}ov=document.createElement("option");ov.setAttribute("role","option");ov.value=sv[0];ov.innerHTML=sv[1];m.appendChild(ov);if(!q&&($.trim(sv[0])==$.trim(j)||$.trim(sv[1])==$.trim(j))){ov.selected="selected"}if(q&&($.inArray($.trim(sv[1]),ovm)>-1||$.inArray($.trim(sv[0]),ovm)>-1)){ov.selected="selected"}}}else if(typeof h.value==='object'){var s=h.value;for(var t in s){if(s.hasOwnProperty(t)){ov=document.createElement("option");ov.setAttribute("role","option");ov.value=t;ov.innerHTML=s[t];m.appendChild(ov);if(!q&&($.trim(t)==$.trim(j)||$.trim(s[t])==$.trim(j))){ov.selected="selected"}if(q&&($.inArray($.trim(s[t]),ovm)>-1||$.inArray($.trim(t),ovm)>-1)){ov.selected="selected"}}}}setAttributes(m,h,['value']);h=bindEv(m,h)}break;case"text":case"password":case"button":var u;if(g=="button"){u="button"}else{u="textbox"}m=document.createElement("input");m.type=g;m.value=j;setAttributes(m,h);h=bindEv(m,h);if(g!="button"){if(k){if(!h.size){$(m).css({width:"98%"})}}else if(!h.size){h.size=20}}$(m).attr("role",u);break;case"image":case"file":m=document.createElement("input");m.type=g;setAttributes(m,h);h=bindEv(m,h);break;case"custom":m=document.createElement("span");try{if($.isFunction(h.custom_element)){var v=h.custom_element.call($t,j,h);if(v){v=$(v).addClass("customelement").attr({id:h.id,name:h.name});$(m).empty().append(v)}else{throw"e2";}}else{throw"e1";}}catch(e){if(e=="e1"){$.jgrid.info_dialog($.jgrid.errors.errcap,"function 'custom_element' "+$.jgrid.edit.msg.nodefined,$.jgrid.edit.bClose)}if(e=="e2"){$.jgrid.info_dialog($.jgrid.errors.errcap,"function 'custom_element' "+$.jgrid.edit.msg.novalue,$.jgrid.edit.bClose)}else{$.jgrid.info_dialog($.jgrid.errors.errcap,typeof(e)==="string"?e:e.message,$.jgrid.edit.bClose)}}break}return m},checkDate:function(b,c){var d=function(a){return(((a%4===0)&&(a%100!==0||(a%400===0)))?29:28)},DaysArray=function(n){for(var i=1;i<=n;i++){this[i]=31;if(i==4||i==6||i==9||i==11){this[i]=30}if(i==2){this[i]=29}}return this};var e={},sep;b=b.toLowerCase();if(b.indexOf("/")!=-1){sep="/"}else if(b.indexOf("-")!=-1){sep="-"}else if(b.indexOf(".")!=-1){sep="."}else{sep="/"}b=b.split(sep);c=c.split(sep);if(c.length!=3){return false}var j=-1,yln,dln=-1,mln=-1;for(var i=0;i<b.length;i++){var f=isNaN(c[i])?0:parseInt(c[i],10);e[b[i]]=f;yln=b[i];if(yln.indexOf("y")!=-1){j=i}if(yln.indexOf("m")!=-1){mln=i}if(yln.indexOf("d")!=-1){dln=i}}if(b[j]=="y"||b[j]=="yyyy"){yln=4}else if(b[j]=="yy"){yln=2}else{yln=-1}var g=DaysArray(12),strDate;if(j===-1){return false}else{strDate=e[b[j]].toString();if(yln==2&&strDate.length==1){yln=1}if(strDate.length!=yln||(e[b[j]]===0&&c[j]!="00")){return false}}if(mln===-1){return false}else{strDate=e[b[mln]].toString();if(strDate.length<1||e[b[mln]]<1||e[b[mln]]>12){return false}}if(dln===-1){return false}else{strDate=e[b[dln]].toString();if(strDate.length<1||e[b[dln]]<1||e[b[dln]]>31||(e[b[mln]]==2&&e[b[dln]]>d(e[b[j]]))||e[b[dln]]>g[e[b[mln]]]){return false}}return true},isEmpty:function(a){if(a.match(/^\s+$/)||a===""){return true}else{return false}},checkTime:function(a){var b=/^(\d{1,2}):(\d{2})([ap]m)?$/,regs;if(!$.jgrid.isEmpty(a)){regs=a.match(b);if(regs){if(regs[3]){if(regs[1]<1||regs[1]>12){return false}}else{if(regs[1]>23){return false}}if(regs[2]>59){return false}}else{return false}}return true},checkValues:function(a,b,g,c,d){var f,i,nm,dft,len;if(typeof(c)==="undefined"){if(typeof(b)=='string'){for(i=0,len=g.p.colModel.length;i<len;i++){if(g.p.colModel[i].name==b){f=g.p.colModel[i].editrules;b=i;try{nm=g.p.colModel[i].formoptions.label}catch(e){}break}}}else if(b>=0){f=g.p.colModel[b].editrules}}else{f=c;nm=d===undefined?"_":d}if(f){if(!nm){nm=g.p.colNames[b]}if(f.required===true){if($.jgrid.isEmpty(a)){return[false,nm+": "+$.jgrid.edit.msg.required,""]}}var h=f.required===false?false:true;if(f.number===true){if(!(h===false&&$.jgrid.isEmpty(a))){if(isNaN(a)){return[false,nm+": "+$.jgrid.edit.msg.number,""]}}}if(typeof f.minValue!='undefined'&&!isNaN(f.minValue)){if(parseFloat(a)<parseFloat(f.minValue)){return[false,nm+": "+$.jgrid.edit.msg.minValue+" "+f.minValue,""]}}if(typeof f.maxValue!='undefined'&&!isNaN(f.maxValue)){if(parseFloat(a)>parseFloat(f.maxValue)){return[false,nm+": "+$.jgrid.edit.msg.maxValue+" "+f.maxValue,""]}}var j;if(f.email===true){if(!(h===false&&$.jgrid.isEmpty(a))){j=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i;if(!j.test(a)){return[false,nm+": "+$.jgrid.edit.msg.email,""]}}}if(f.integer===true){if(!(h===false&&$.jgrid.isEmpty(a))){if(isNaN(a)){return[false,nm+": "+$.jgrid.edit.msg.integer,""]}if((a%1!==0)||(a.indexOf('.')!=-1)){return[false,nm+": "+$.jgrid.edit.msg.integer,""]}}}if(f.date===true){if(!(h===false&&$.jgrid.isEmpty(a))){if(g.p.colModel[b].formatoptions&&g.p.colModel[b].formatoptions.newformat){dft=g.p.colModel[b].formatoptions.newformat}else{dft=g.p.colModel[b].datefmt||"Y-m-d"}if(!$.jgrid.checkDate(dft,a)){return[false,nm+": "+$.jgrid.edit.msg.date+" - "+dft,""]}}}if(f.time===true){if(!(h===false&&$.jgrid.isEmpty(a))){if(!$.jgrid.checkTime(a)){return[false,nm+": "+$.jgrid.edit.msg.date+" - hh:mm (am/pm)",""]}}}if(f.url===true){if(!(h===false&&$.jgrid.isEmpty(a))){j=/^(((https?)|(ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i;if(!j.test(a)){return[false,nm+": "+$.jgrid.edit.msg.url,""]}}}if(f.custom===true){if(!(h===false&&$.jgrid.isEmpty(a))){if($.isFunction(f.custom_func)){var k=f.custom_func.call(g,a,nm);if($.isArray(k)){return k}else{return[false,$.jgrid.edit.msg.customarray,""]}}else{return[false,$.jgrid.edit.msg.customfcheck,""]}}}}return[true,"",""]}})})(jQuery);