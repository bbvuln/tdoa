/*
**
 * jqGrid addons using jQuery UI 
 * Author: Mark Williams
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
 * depends on jQuery UI 
**/
;(function($){if($.browser.msie&&$.browser.version==8){$.expr[":"].hidden=function(a){return a.offsetWidth===0||a.offsetHeight===0||a.style.display=="none"}}$.jgrid._multiselect=false;if($.ui){if($.ui.multiselect){if($.ui.multiselect.prototype._setSelected){var q=$.ui.multiselect.prototype._setSelected;$.ui.multiselect.prototype._setSelected=function(a,b){var c=q.call(this,a,b);if(b&&this.selectedList){var d=this.element;this.selectedList.find('li').each(function(){if($(this).data('optionLink')){$(this).data('optionLink').remove().appendTo(d)}})}return c}}if($.ui.multiselect.prototype.destroy){$.ui.multiselect.prototype.destroy=function(){this.element.show();this.container.remove();if($.Widget===undefined){$.widget.prototype.destroy.apply(this,arguments)}else{$.Widget.prototype.destroy.apply(this,arguments)}}}$.jgrid._multiselect=true}}$.jgrid.extend({sortableColumns:function(h){return this.each(function(){var f=this,tid=$.jgrid.jqID(f.p.id);function start(){f.p.disableClick=true}var g={"tolerance":"pointer","axis":"x","scrollSensitivity":"1","items":'>th:not(:has(#jqgh_'+tid+'_cb'+',#jqgh_'+tid+'_rn'+',#jqgh_'+tid+'_subgrid),:hidden)',"placeholder":{element:function(a){var b=$(document.createElement(a[0].nodeName)).addClass(a[0].className+" ui-sortable-placeholder ui-state-highlight").removeClass("ui-sortable-helper")[0];return b},update:function(a,p){p.height(a.currentItem.innerHeight()-parseInt(a.currentItem.css('paddingTop')||0,10)-parseInt(a.currentItem.css('paddingBottom')||0,10));p.width(a.currentItem.innerWidth()-parseInt(a.currentItem.css('paddingLeft')||0,10)-parseInt(a.currentItem.css('paddingRight')||0,10))}},"update":function(b,c){var p=$(c.item).parent(),th=$(">th",p),colModel=f.p.colModel,cmMap={},tid=f.p.id+"_";$.each(colModel,function(i){cmMap[this.name]=i});var d=[];th.each(function(){var a=$(">div",this).get(0).id.replace(/^jqgh_/,"").replace(tid,"");if(a in cmMap){d.push(cmMap[a])}});$(f).jqGrid("remapColumns",d,true,true);if($.isFunction(f.p.sortable.update)){f.p.sortable.update(d)}setTimeout(function(){f.p.disableClick=false},50)}};if(f.p.sortable.options){$.extend(g,f.p.sortable.options)}else if($.isFunction(f.p.sortable)){f.p.sortable={"update":f.p.sortable}}if(g.start){var s=g.start;g.start=function(e,a){start();s.call(this,e,a)}}else{g.start=start}if(f.p.sortable.exclude){g.items+=":not("+f.p.sortable.exclude+")"}h.sortable(g).data("sortable").floating=true})},columnChooser:function(d){var e=this;if($("#colchooser_"+$.jgrid.jqID(e[0].p.id)).length){return}var f=$('<div id="colchooser_'+e[0].p.id+'" style="position:relative;overflow:hidden"><div><select multiple="multiple"></select></div></div>');var g=$('select',f);function insert(c,i,v){if(i>=0){var a=c.slice();var b=a.splice(i,Math.max(c.length-i,i));if(i>c.length){i=c.length}a[i]=v;return a.concat(b)}}d=$.extend({"width":420,"height":240,"classname":null,"done":function(a){if(a){e.jqGrid("remapColumns",a,true)}},"msel":"multiselect","dlog":"dialog","dialog_opts":{"minWidth":470},"dlog_opts":function(a){var b={};b[a.bSubmit]=function(){a.apply_perm();a.cleanup(false)};b[a.bCancel]=function(){a.cleanup(true)};return $.extend(true,{"buttons":b,"close":function(){a.cleanup(true)},"modal":a.modal?a.modal:false,"resizable":a.resizable?a.resizable:true,"width":a.width+20},a.dialog_opts||{})},"apply_perm":function(){$('option',g).each(function(){if(this.selected){e.jqGrid("showCol",h[this.value].name)}else{e.jqGrid("hideCol",h[this.value].name)}});var b=[];$('option:selected',g).each(function(){b.push(parseInt(this.value,10))});$.each(b,function(){delete k[h[parseInt(this,10)].name]});$.each(k,function(){var a=parseInt(this,10);b=insert(b,a,a)});if(d.done){d.done.call(e,b)}},"cleanup":function(a){call(d.dlog,f,'destroy');call(d.msel,g,'destroy');f.remove();if(a&&d.done){d.done.call(e)}},"msel_opts":{}},$.jgrid.col,d||{});if($.ui){if($.ui.multiselect){if(d.msel=="multiselect"){if(!$.jgrid._multiselect){alert("Multiselect plugin loaded after jqGrid. Please load the plugin before the jqGrid!");return}d.msel_opts=$.extend($.ui.multiselect.defaults,d.msel_opts)}}}if(d.caption){f.attr("title",d.caption)}if(d.classname){f.addClass(d.classname);g.addClass(d.classname)}if(d.width){$(">div",f).css({"width":d.width,"margin":"0 auto"});g.css("width",d.width)}if(d.height){$(">div",f).css("height",d.height);g.css("height",d.height-10)}var h=e.jqGrid("getGridParam","colModel");var j=e.jqGrid("getGridParam","colNames");var k={},fixedCols=[];g.empty();$.each(h,function(i){k[this.name]=i;if(this.hidedlg){if(!this.hidden){fixedCols.push(i)}return}g.append("<option value='"+i+"' "+(this.hidden?"":"selected='selected'")+">"+jQuery.jgrid.stripHtml(j[i])+"</option>")});function call(a,b){if(!a){return}if(typeof a=='string'){if($.fn[a]){$.fn[a].apply(b,$.makeArray(arguments).slice(2))}}else if($.isFunction(a)){a.apply(b,$.makeArray(arguments).slice(2))}}var l=$.isFunction(d.dlog_opts)?d.dlog_opts.call(e,d):d.dlog_opts;call(d.dlog,f,l);var m=$.isFunction(d.msel_opts)?d.msel_opts.call(e,d):d.msel_opts;call(d.msel,g,m)},sortableRows:function(f){return this.each(function(){var d=this;if(!d.grid){return}if(d.p.treeGrid){return}if($.fn.sortable){f=$.extend({"cursor":"move","axis":"y","items":".jqgrow"},f||{});if(f.start&&$.isFunction(f.start)){f._start_=f.start;delete f.start}else{f._start_=false}if(f.update&&$.isFunction(f.update)){f._update_=f.update;delete f.update}else{f._update_=false}f.start=function(a,b){$(b.item).css("border-width","0px");$("td",b.item).each(function(i){this.style.width=d.grid.cols[i].style.width});if(d.p.subGrid){var c=$(b.item).attr("id");try{$(d).jqGrid('collapseSubGridRow',c)}catch(e){}}if(f._start_){f._start_.apply(this,[a,b])}};f.update=function(a,b){$(b.item).css("border-width","");if(d.p.rownumbers===true){$("td.jqgrid-rownum",d.rows).each(function(i){$(this).html(i+1+(parseInt(d.p.page,10)-1)*parseInt(d.p.rowNum,10))})}if(f._update_){f._update_.apply(this,[a,b])}};$("tbody:first",d).sortable(f);$("tbody:first",d).disableSelection()}})},gridDnD:function(p){return this.each(function(){var l=this;if(!l.grid){return}if(l.p.treeGrid){return}if(!$.fn.draggable||!$.fn.droppable){return}function updateDnD(){var a=$.data(l,"dnd");$("tr.jqgrow:not(.ui-draggable)",l).draggable($.isFunction(a.drag)?a.drag.call($(l),a):a.drag)}var m="<table id='jqgrid_dnd' class='ui-jqgrid-dnd'></table>";if($("#jqgrid_dnd").html()===null){$('body').append(m)}if(typeof p=='string'&&p=='updateDnD'&&l.p.jqgdnd===true){updateDnD();return}p=$.extend({"drag":function(d){return $.extend({start:function(a,b){if(l.p.subGrid){var c=$(b.helper).attr("id");try{$(l).jqGrid('collapseSubGridRow',c)}catch(e){}}for(var i=0;i<$.data(l,"dnd").connectWith.length;i++){if($($.data(l,"dnd").connectWith[i]).jqGrid('getGridParam','reccount')=="0"){$($.data(l,"dnd").connectWith[i]).jqGrid('addRowData','jqg_empty_row',{})}}b.helper.addClass("ui-state-highlight");$("td",b.helper).each(function(i){this.style.width=l.grid.headers[i].width+"px"});if(d.onstart&&$.isFunction(d.onstart)){d.onstart.call($(l),a,b)}},stop:function(a,b){if(b.helper.dropped&&!d.dragcopy){var c=$(b.helper).attr("id");if(c===undefined){c=$(this).attr("id")}$(l).jqGrid('delRowData',c)}for(var i=0;i<$.data(l,"dnd").connectWith.length;i++){$($.data(l,"dnd").connectWith[i]).jqGrid('delRowData','jqg_empty_row')}if(d.onstop&&$.isFunction(d.onstop)){d.onstop.call($(l),a,b)}}},d.drag_opts||{})},"drop":function(k){return $.extend({accept:function(d){if(!$(d).hasClass('jqgrow')){return d}var a=$(d).closest("table.ui-jqgrid-btable");if(a.length>0&&$.data(a[0],"dnd")!==undefined){var b=$.data(a[0],"dnd").connectWith;return $.inArray('#'+$.jgrid.jqID(this.id),b)!=-1?true:false}return false},drop:function(a,b){if(!$(b.draggable).hasClass('jqgrow')){return}var c=$(b.draggable).attr("id");var d=b.draggable.parent().parent().jqGrid('getRowData',c);if(!k.dropbyname){var j=0,tmpdata={},nm;var f=$("#"+$.jgrid.jqID(this.id)).jqGrid('getGridParam','colModel');try{for(var g in d){nm=f[j].name;if(!(nm=='cb'||nm=='rn'||nm=='subgrid')){if(d.hasOwnProperty(g)&&f[j]){tmpdata[nm]=d[g]}}j++}d=tmpdata}catch(e){}}b.helper.dropped=true;if(k.beforedrop&&$.isFunction(k.beforedrop)){var h=k.beforedrop.call(this,a,b,d,$('#'+$.jgrid.jqID(l.p.id)),$(this));if(typeof h!="undefined"&&h!==null&&typeof h=="object"){d=h}}if(b.helper.dropped){var i;if(k.autoid){if($.isFunction(k.autoid)){i=k.autoid.call(this,d)}else{i=Math.ceil(Math.random()*1000);i=k.autoidprefix+i}}$("#"+$.jgrid.jqID(this.id)).jqGrid('addRowData',i,d,k.droppos)}if(k.ondrop&&$.isFunction(k.ondrop)){k.ondrop.call(this,a,b,d)}}},k.drop_opts||{})},"onstart":null,"onstop":null,"beforedrop":null,"ondrop":null,"drop_opts":{"activeClass":"ui-state-active","hoverClass":"ui-state-hover"},"drag_opts":{"revert":"invalid","helper":"clone","cursor":"move","appendTo":"#jqgrid_dnd","zIndex":5000},"dragcopy":false,"dropbyname":false,"droppos":"first","autoid":true,"autoidprefix":"dnd_"},p||{});if(!p.connectWith){return}p.connectWith=p.connectWith.split(",");p.connectWith=$.map(p.connectWith,function(n){return $.trim(n)});$.data(l,"dnd",p);if(l.p.reccount!="0"&&!l.p.jqgdnd){updateDnD()}l.p.jqgdnd=true;for(var i=0;i<p.connectWith.length;i++){var o=p.connectWith[i];$(o).droppable($.isFunction(p.drop)?p.drop.call($(l),p):p.drop)}})},gridResize:function(e){return this.each(function(){var c=this,gID=$.jgrid.jqID(c.p.id);if(!c.grid||!$.fn.resizable){return}e=$.extend({},e||{});if(e.alsoResize){e._alsoResize_=e.alsoResize;delete e.alsoResize}else{e._alsoResize_=false}if(e.stop&&$.isFunction(e.stop)){e._stop_=e.stop;delete e.stop}else{e._stop_=false}e.stop=function(a,b){$(c).jqGrid('setGridParam',{height:$("#gview_"+gID+" .ui-jqgrid-bdiv").height()});$(c).jqGrid('setGridWidth',b.size.width,e.shrinkToFit);if(e._stop_){e._stop_.call(c,a,b)}};if(e._alsoResize_){var d="{\'#gview_"+gID+" .ui-jqgrid-bdiv\':true,'"+e._alsoResize_+"':true}";e.alsoResize=eval('('+d+')')}else{e.alsoResize=$(".ui-jqgrid-bdiv","#gview_"+gID)}delete e._alsoResize_;$("#gbox_"+gID).resizable(e)})}})})(jQuery);
