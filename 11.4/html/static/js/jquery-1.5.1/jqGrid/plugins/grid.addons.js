/*
 * jqGrid methods without support. Use as you wish
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
 *
 * This list of deprecated methods.
 * If you instead want to use them, please include this file after the grid main file.
 * Some methods will be then overwritten.
 *
 */
/*global jQuery, $ */
(function($){$.jgrid.extend({searchGrid:function(p){p=$.extend({recreateFilter:false,drag:true,sField:'searchField',sValue:'searchString',sOper:'searchOper',sFilter:'filters',loadDefaults:true,beforeShowSearch:null,afterShowSearch:null,onInitializeSearch:null,closeAfterSearch:false,closeAfterReset:false,closeOnEscape:false,multipleSearch:false,cloneSearchRowOnAdd:true,sopt:null,stringResult:undefined,onClose:null,useDataProxy:false,overlay:true},$.jgrid.search,p||{});return this.each(function(){var g=this;if(!g.grid){return}var h="fbox_"+g.p.id,showFrm=true;function applyDefaultFilters(a,b){var c=a.p.postData[b.sFilter];if(typeof(c)=="string"){c=$.jgrid.parse(c)}if(c){if(c.groupOp){a.SearchFilter.setGroupOp(c.groupOp)}if(c.rules){var f,i=0,li=c.rules.length,success=false;for(;i<li;i++){f=c.rules[i];if(f.field!==undefined&&f.op!==undefined&&f.data!==undefined){success=a.SearchFilter.setFilter({'sfref':a.SearchFilter.$.find(".sf:last"),'filter':$.extend({},f)});if(success){a.SearchFilter.add()}}}}}}function hideFilter(a){if(p.onClose){var b=p.onClose(a);if(typeof b=='boolean'&&!b){return}}a.hide();if(p.overlay===true){$(".jqgrid-overlay:first","#gbox_"+g.p.id).hide()}}function showFilter(){var a=$(".ui-searchFilter").length;if(a>1){var b=$("#"+h).css("zIndex");$("#"+h).css({zIndex:parseInt(b,10)+a})}$("#"+h).show();if(p.overlay===true){$(".jqgrid-overlay:first","#gbox_"+g.p.id).show()}try{$(':input:visible',"#"+h)[0].focus()}catch(_){}}function searchFilters(a){var b=(a!==undefined),grid=$("#"+g.p.id),sdata={};if(p.multipleSearch===false){sdata[p.sField]=a.rules[0].field;sdata[p.sValue]=a.rules[0].data;sdata[p.sOper]=a.rules[0].op;if(sdata.hasOwnProperty(p.sFilter)){delete sdata[p.sFilter]}}else{sdata[p.sFilter]=a;$.each([p.sField,p.sValue,p.sOper],function(i,n){if(sdata.hasOwnProperty(n)){delete sdata[n]}})}grid[0].p.search=b;$.extend(grid[0].p.postData,sdata);grid.trigger("reloadGrid",[{page:1}]);if(p.closeAfterSearch){hideFilter($("#"+h))}}function resetFilters(a){var b=a&&a.hasOwnProperty("reload")?a.reload:true,grid=$("#"+g.p.id),sdata={};grid[0].p.search=false;if(p.multipleSearch===false){sdata[p.sField]=sdata[p.sValue]=sdata[p.sOper]=""}else{sdata[p.sFilter]=""}$.extend(grid[0].p.postData,sdata);if(b){grid.trigger("reloadGrid",[{page:1}])}if(p.closeAfterReset){hideFilter($("#"+h))}}if($.fn.searchFilter){if(p.recreateFilter===true){$("#"+h).remove()}if($("#"+h).html()!==null){if($.isFunction(p.beforeShowSearch)){showFrm=p.beforeShowSearch($("#"+h));if(typeof(showFrm)=="undefined"){showFrm=true}}if(showFrm===false){return}showFilter();if($.isFunction(p.afterShowSearch)){p.afterShowSearch($("#"+h))}}else{var l=[],colNames=$("#"+g.p.id).jqGrid("getGridParam","colNames"),colModel=$("#"+g.p.id).jqGrid("getGridParam","colModel"),stempl=['eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','cn','nc'],j,pos,k,oprtr=[];if(p.sopt!==null){k=0;for(j=0;j<p.sopt.length;j++){if((pos=$.inArray(p.sopt[j],stempl))!=-1){oprtr[k]={op:p.sopt[j],text:p.odata[pos]};k++}}}else{for(j=0;j<stempl.length;j++){oprtr[j]={op:stempl[j],text:p.odata[j]}}}$.each(colModel,function(i,v){var a=(typeof v.search==='undefined')?true:v.search,hidden=(v.hidden===true),soptions=$.extend({},{text:colNames[i],itemval:v.index||v.name},this.searchoptions),ignoreHiding=(soptions.searchhidden===true);if(typeof soptions.sopt!=='undefined'){k=0;soptions.ops=[];if(soptions.sopt.length>0){for(j=0;j<soptions.sopt.length;j++){if((pos=$.inArray(soptions.sopt[j],stempl))!=-1){soptions.ops[k]={op:soptions.sopt[j],text:p.odata[pos]};k++}}}}if(typeof(this.stype)==='undefined'){this.stype='text'}if(this.stype=='select'){if(soptions.dataUrl!==undefined){}else{var b;if(soptions.value){b=soptions.value}else if(this.editoptions){b=this.editoptions.value}if(b){soptions.dataValues=[];if(typeof(b)==='string'){var c=b.split(";"),sv;for(j=0;j<c.length;j++){sv=c[j].split(":");soptions.dataValues[j]={value:sv[0],text:sv[1]}}}else if(typeof(b)==='object'){j=0;for(var d in b){if(b.hasOwnProperty(d)){soptions.dataValues[j]={value:d,text:b[d]};j++}}}}}}if((ignoreHiding&&a)||(a&&!hidden)){l.push(soptions)}});if(l.length>0){$("<div id='"+h+"' role='dialog' tabindex='-1'></div>").insertBefore("#gview_"+g.p.id);if(p.stringResult===undefined){p.stringResult=p.multipleSearch}g.SearchFilter=$("#"+h).searchFilter(l,{groupOps:p.groupOps,operators:oprtr,onClose:hideFilter,resetText:p.Reset,searchText:p.Find,windowTitle:p.caption,rulesText:p.rulesText,matchText:p.matchText,onSearch:searchFilters,onReset:resetFilters,stringResult:p.stringResult,ajaxSelectOptions:$.extend({},$.jgrid.ajaxOptions,g.p.ajaxSelectOptions||{}),clone:p.cloneSearchRowOnAdd});$(".ui-widget-overlay","#"+h).remove();if(g.p.direction=="rtl"){$(".ui-closer","#"+h).css("float","left")}if(p.drag===true){$("#"+h+" table thead tr:first td:first").css('cursor','move');if(jQuery.fn.jqDrag){$("#"+h).jqDrag($("#"+h+" table thead tr:first td:first"))}else{try{$("#"+h).draggable({handle:$("#"+h+" table thead tr:first td:first")})}catch(e){}}}if(p.multipleSearch===false){$(".ui-del, .ui-add, .ui-del, .ui-add-last, .matchText, .rulesText","#"+h).hide();$("select[name='groupOp']","#"+h).hide()}if(p.multipleSearch===true&&p.loadDefaults===true){applyDefaultFilters(g,p)}if($.isFunction(p.onInitializeSearch)){p.onInitializeSearch($("#"+h))}if($.isFunction(p.beforeShowSearch)){showFrm=p.beforeShowSearch($("#"+h));if(typeof(showFrm)=="undefined"){showFrm=true}}if(showFrm===false){return}showFilter();if($.isFunction(p.afterShowSearch)){p.afterShowSearch($("#"+h))}if(p.closeOnEscape===true){$("#"+h).keydown(function(e){if(e.which==27){hideFilter($("#"+h))}if(e.which==13){$(".ui-search",this).click()}})}}}}})},updateGridRows:function(a,b,c){var d,success=false,title;this.each(function(){var t=this,vl,ind,srow,sid;if(!t.grid){return false}if(!b){b="id"}if(a&&a.length>0){$(a).each(function(j){srow=this;ind=t.rows.namedItem(srow[b]);if(ind){sid=srow[b];if(c===true){if(t.p.jsonReader.repeatitems===true){if(t.p.jsonReader.cell){srow=srow[t.p.jsonReader.cell]}for(var k=0;k<srow.length;k++){vl=t.formatter(sid,srow[k],k,srow,'edit');title=t.p.colModel[k].title?{"title":$.jgrid.stripHtml(vl)}:{};if(t.p.treeGrid===true&&d==t.p.ExpandColumn){$("td:eq("+k+") > span:first",ind).html(vl).attr(title)}else{$("td:eq("+k+")",ind).html(vl).attr(title)}}success=true;return true}}$(t.p.colModel).each(function(i){d=c===true?this.jsonmap||this.name:this.name;if(srow[d]!==undefined){vl=t.formatter(sid,srow[d],i,srow,'edit');title=this.title?{"title":$.jgrid.stripHtml(vl)}:{};if(t.p.treeGrid===true&&d==t.p.ExpandColumn){$("td:eq("+i+") > span:first",ind).html(vl).attr(title)}else{$("td:eq("+i+")",ind).html(vl).attr(title)}success=true}})}})}});return success},filterGrid:function(z,p){p=$.extend({gridModel:false,gridNames:false,gridToolbar:false,filterModel:[],formtype:"horizontal",autosearch:true,formclass:"filterform",tableclass:"filtertable",buttonclass:"filterbutton",searchButton:"Search",clearButton:"Clear",enableSearch:false,enableClear:false,beforeSearch:null,afterSearch:null,beforeClear:null,afterClear:null,url:'',marksearched:true},p||{});return this.each(function(){var m=this;this.p=p;if(this.p.filterModel.length===0&&this.p.gridModel===false){alert("No filter is set");return}if(!z){alert("No target grid is set!");return}this.p.gridid=z.indexOf("#")!=-1?z:"#"+z;var o=$(this.p.gridid).jqGrid("getGridParam",'colModel');if(o){if(this.p.gridModel===true){var q=$(this.p.gridid)[0];var r;$.each(o,function(i,n){var a=[];this.search=this.search===false?false:true;if(this.editrules&&this.editrules.searchhidden===true){r=true}else{if(this.hidden===true){r=false}else{r=true}}if(this.search===true&&r===true){if(m.p.gridNames===true){a.label=q.p.colNames[i]}else{a.label=''}a.name=this.name;a.index=this.index||this.name;a.stype=this.edittype||'text';if(a.stype!='select'){a.stype='text'}a.defval=this.defval||'';a.surl=this.surl||'';a.sopt=this.editoptions||{};a.width=this.width;m.p.filterModel.push(a)}})}else{$.each(m.p.filterModel,function(i,n){for(var j=0;j<o.length;j++){if(this.name==o[j].name){this.index=o[j].index||this.name;break}}if(!this.index){this.index=this.name}})}}else{alert("Could not get grid colModel");return}var s=function(){var a={},j=0,v;var b=$(m.p.gridid)[0],nm;b.p.searchdata={};if($.isFunction(m.p.beforeSearch)){m.p.beforeSearch()}$.each(m.p.filterModel,function(i,n){nm=this.index;if(this.stype==='select'){v=$("select[name="+nm+"]",m).val();if(v){a[nm]=v;if(m.p.marksearched){$("#jqgh_"+this.name,b.grid.hDiv).addClass("dirty-cell")}j++}else{if(m.p.marksearched){$("#jqgh_"+this.name,b.grid.hDiv).removeClass("dirty-cell")}try{delete b.p.postData[this.index]}catch(e){}}}else{v=$("input[name="+nm+"]",m).val();if(v){a[nm]=v;if(m.p.marksearched){$("#jqgh_"+this.name,b.grid.hDiv).addClass("dirty-cell")}j++}else{if(m.p.marksearched){$("#jqgh_"+this.name,b.grid.hDiv).removeClass("dirty-cell")}try{delete b.p.postData[this.index]}catch(x){}}}});var c=j>0?true:false;$.extend(b.p.postData,a);var d;if(m.p.url){d=$(b).jqGrid("getGridParam",'url');$(b).jqGrid("setGridParam",{url:m.p.url})}$(b).jqGrid("setGridParam",{search:c}).trigger("reloadGrid",[{page:1}]);if(d){$(b).jqGrid("setGridParam",{url:d})}if($.isFunction(m.p.afterSearch)){m.p.afterSearch()}};var t=function(){var b={},v,j=0;var c=$(m.p.gridid)[0],nm;if($.isFunction(m.p.beforeClear)){m.p.beforeClear()}$.each(m.p.filterModel,function(i,n){nm=this.index;v=(this.defval)?this.defval:"";if(!this.stype){this.stype='text'}switch(this.stype){case'select':var a;$("select[name="+nm+"] option",m).each(function(i){if(i===0){this.selected=true}if($(this).text()==v){this.selected=true;a=$(this).val();return false}});if(a){b[nm]=a;if(m.p.marksearched){$("#jqgh_"+this.name,c.grid.hDiv).addClass("dirty-cell")}j++}else{if(m.p.marksearched){$("#jqgh_"+this.name,c.grid.hDiv).removeClass("dirty-cell")}try{delete c.p.postData[this.index]}catch(e){}}break;case'text':$("input[name="+nm+"]",m).val(v);if(v){b[nm]=v;if(m.p.marksearched){$("#jqgh_"+this.name,c.grid.hDiv).addClass("dirty-cell")}j++}else{if(m.p.marksearched){$("#jqgh_"+this.name,c.grid.hDiv).removeClass("dirty-cell")}try{delete c.p.postData[this.index]}catch(k){}}break}});var d=j>0?true:false;$.extend(c.p.postData,b);var f;if(m.p.url){f=$(c).jqGrid("getGridParam",'url');$(c).jqGrid("setGridParam",{url:m.p.url})}$(c).jqGrid("setGridParam",{search:d}).trigger("reloadGrid",[{page:1}]);if(f){$(c).jqGrid("setGridParam",{url:f})}if($.isFunction(m.p.afterClear)){m.p.afterClear()}};var u;var w=function(){var j=document.createElement("tr");var l,sb,cb,tl,td;if(m.p.formtype=='horizontal'){$(u).append(j)}$.each(m.p.filterModel,function(i,n){tl=document.createElement("td");$(tl).append("<label for='"+this.name+"'>"+this.label+"</label>");td=document.createElement("td");var b=this;if(!this.stype){this.stype='text'}switch(this.stype){case"select":if(this.surl){$(td).load(this.surl,function(){if(b.defval){$("select",this).val(b.defval)}$("select",this).attr({name:b.index||b.name,id:"sg_"+b.name});if(b.sopt){$("select",this).attr(b.sopt)}if(m.p.gridToolbar===true&&b.width){$("select",this).width(b.width)}if(m.p.autosearch===true){$("select",this).change(function(e){s();return false})}})}else{if(b.sopt.value){var c=b.sopt.value;var d=document.createElement("select");$(d).attr({name:b.index||b.name,id:"sg_"+b.name}).attr(b.sopt);var f,sv,ov;if(typeof c==="string"){f=c.split(";");for(var k=0;k<f.length;k++){sv=f[k].split(":");ov=document.createElement("option");ov.value=sv[0];ov.innerHTML=sv[1];if(sv[1]==b.defval){ov.selected="selected"}d.appendChild(ov)}}else if(typeof c==="object"){for(var g in c){if(c.hasOwnProperty(g)){i++;ov=document.createElement("option");ov.value=g;ov.innerHTML=c[g];if(c[g]==b.defval){ov.selected="selected"}d.appendChild(ov)}}}if(m.p.gridToolbar===true&&b.width){$(d).width(b.width)}$(td).append(d);if(m.p.autosearch===true){$(d).change(function(e){s();return false})}}}break;case'text':var h=this.defval?this.defval:"";$(td).append("<input type='text' name='"+(this.index||this.name)+"' id='sg_"+this.name+"' value='"+h+"'/>");if(b.sopt){$("input",td).attr(b.sopt)}if(m.p.gridToolbar===true&&b.width){if($.browser.msie){$("input",td).width(b.width-4)}else{$("input",td).width(b.width-2)}}if(m.p.autosearch===true){$("input",td).keypress(function(e){var a=e.charCode?e.charCode:e.keyCode?e.keyCode:0;if(a==13){s();return false}return this})}break}if(m.p.formtype=='horizontal'){if(m.p.gridToolbar===true&&m.p.gridNames===false){$(j).append(td)}else{$(j).append(tl).append(td)}$(j).append(td)}else{l=document.createElement("tr");$(l).append(tl).append(td);$(u).append(l)}});td=document.createElement("td");if(m.p.enableSearch===true){sb="<input type='button' id='sButton' class='"+m.p.buttonclass+"' value='"+m.p.searchButton+"'/>";$(td).append(sb);$("input#sButton",td).click(function(){s();return false})}if(m.p.enableClear===true){cb="<input type='button' id='cButton' class='"+m.p.buttonclass+"' value='"+m.p.clearButton+"'/>";$(td).append(cb);$("input#cButton",td).click(function(){t();return false})}if(m.p.enableClear===true||m.p.enableSearch===true){if(m.p.formtype=='horizontal'){$(j).append(td)}else{l=document.createElement("tr");$(l).append("<td>&#160;</td>").append(td);$(u).append(l)}}};var y=$("<form name='SearchForm' style=display:inline;' class='"+this.p.formclass+"'></form>");u=$("<table class='"+this.p.tableclass+"' cellspacing='0' cellpading='0' border='0'><tbody></tbody></table>");$(y).append(u);w();$(this).append(y);this.triggerSearch=s;this.clearSearch=t})}})})(jQuery);
