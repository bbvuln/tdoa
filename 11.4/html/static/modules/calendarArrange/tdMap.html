<!DOCTYPE html>


<head>
    <meta charset="utf-8" />
    <!--<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">-->
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />
    <title>地图控件</title>
    <link rel="stylesheet" href="/static/common/iconfont/iconfont.css">
    <script type="text/javascript" src="../../js/jquery-1.10.2/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/bootstrap/js/bootstrap.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.3&key=7aa95e54f2e6390820b00f695ddb4ad5"></script>
    <style>

        html,body{
    	height: 100%;
    	background: #f2f2f2;
    	overflow: hidden;
    }
    .clearfix:after{
        content: "";
        display: table;
        clear: both;
    }
    .container{
        width: 100%;
        height: 100%;
        /* width: 550px; */
        overflow: hidden;
        margin: 0 auto;
        position: relative;
        background: #fff;
    
        /* -webkit-box-orient: horizontal;
        -webkit-box-direction: normal;
        -webkit-flex-direction: row;
        -ms-flex-direction: row;
        flex-direction: row;
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
       
        -webkit-flex: auto;
        -ms-flex: auto;
        flex: auto; */
    }
    .container .side{
        height: 100%;
        min-width: 200px;
        border-right: 1px solid #ddd;
        box-sizing: border-box;
        display: inline-block;
        float: left;
        background: #F7F7F7;
        position: relative;
    }
    .container .content{
        height: 104%;
        box-sizing: border-box;
        position: relative;
        display: inline-block;
        width: 74%;
        width: calc(100% - 200px);
       
    }
   
    .tabs-content{
        background: #F7F7F7;
        font-size: 13px;
        /* padding: 0 40px; */
        height: calc(100% - 50px);
        padding-top: 14px;
        box-sizing: border-box;
        padding-bottom: 20px;
    
    }
    
    
 
   
    .content-button{
        position: absolute;
        bottom: 0;
        width: 100%;
        text-align: center;
        padding: 12px 0 20px 0;
    }
    .content-button button{
        color: #fff;
        background-color: #1890ff;
        border-color: #1890ff;
        text-shadow: 0 -1px 0 rgba(0,0,0,0.12);
        -webkit-box-shadow: 0 2px 0 rgba(0,0,0,0.045);
        box-shadow: 0 2px 0 rgba(0,0,0,0.045);
        line-height: 1.499;
        display: inline-block;
        font-weight: 400;
        text-align: center;
        -ms-touch-action: manipulation;
        touch-action: manipulation;
        cursor: pointer;
        background-image: none;
        border: 1px solid transparent;
        white-space: nowrap;
        padding: 0 28px;
        font-size: 14px;
        border-radius: 4px;
        height: 24px;
    }
    .content-bottom{
        text-align: left;
        padding-right: 10px;
        padding-bottom: 10px;
        font-size: 13px;
        height: 68px;
    }
    .content-button .deleteAll{
        color: #666;
        background: #fff;
        border: 0;
        cursor: pointer;
        outline: none;
        padding: 0;
        text-shadow: none;
        box-shadow: none;
    }
    
    .content-button button.deleteAll:hover,.content-button button.deleteAll:hover span{
        color: #0084ff;
    }
    
    .deleteAll button:focus{
        outline:0
    }
    .search{
        height: 26px;
        position: relative;
        box-sizing: border-box;
        margin: 12px;
        border: 1px solid #d9d9d9;
        border-radius: 5px;
    }
    .search input[type="search"],
    .search input[type="text"]{
        height: 26px;
        line-height: 26px;
        width: 100%;
        position:absolute;
        left: 0;
        top: 0;
        background: transparent;
        border: 0;
        padding: 0 10px 0 35px;
        z-index: 4;
        box-sizing: border-box;
        border-radius: 5px;
    
    }
    input::-webkit-input-placeholder{
        color: #999;
    }
    .icon-query{
        margin-left: 10px;
        position: relative;
        top: 3px;
        color: #999;
    }
    /*.icon-query:before {*/
    /*    content: "\e713";*/
    /*}*/
    .search-content{
        display: none;
        position: absolute;
        width: 100%;
        background: #fff;
        z-index: 1000;
        padding-right: 8px;
        height: calc(100% - 132px);
        box-sizing: border-box;
    }
    .search-content li{
        padding: 10px 20px;
        cursor: pointer;
        font-size: 14px;
    }
    .search-content.active,
    .search-content .icon-new-mark.active{
        display: block;
    }
    .search-content li.active{
        /* background: #ddd; */
    }
    
    .search-content li span.icon-new-mark{
        display: none;
        float: right;
        /* padding-top: 4px; */
        color: #4BA7FF;
    }
    .selectRange{
        display: inline-block;
        font-size: 13px;
        padding: 12px 0 0 12px;
        height: 26px;
        line-height: 26px;
    }
    .selectRange select{
        height: 26px;
        line-height: 26px;
        width: 93px;
    }
    
    
    </style>
</head>

<body>
    <div class="container ">
        <div class="side">
             <label class="selectRange" style="display:none;">
                    <span class="">选择有效范围</span>
                        <select id="range">
                            <option value="100">100米</option>
                            <option value="200">200米</option>
                            <option selected="" value="300">300米</option>
                            <option value="400">400米</option>
                            <option value="500">500米</option>
                            <option value="600">600米</option>
                            <option value="700">700米</option>
                            <option value="800">800米</option>
                            <option value="900">900米</option>
                            <option value="1000">1000米</option>
                            <option value="2000">2000米</option>
                            <option value="3000">3000米</option>
                        </select>
                    
            </label>
            <div class="search">
                <div class="search-input">
                    <span class="icon  iconfont icon-query"></span>
                    <input type="text" class="" id="suggestId" placeholder="请输入" value="">
                </div>
            </div>
            <div class="search-content ">
                <ul id=search-ui-content></ul>
            </div>
            <div class="content-button">
                <div class="content-bottom" >
                    <span class="">详细地址:</span>
                    <br>
                    <span class="locationStr"></span>
                </div>
                <button type="button" class="ant-btn  okBtn" id="subLocat"><span>确定</span></button>
            </div>
        </div>
        <div class="content">
            <div id="myMap" style="width: 100%;height: 100%;">

            </div>
        </div>
    </div>
    <script>
        $(function () {
            var locationStr;
            var locationPx=getQueryString('lng')?parseFloat(getQueryString('lng')):0 ; 

            var locationPy=getQueryString('lat')?parseFloat(getQueryString('lat')):0; 
            // var locationPx=114.31;
            // var locationPy=30.52;
            var position=[locationPx,locationPy]
            var htmlAdd = '';
            var mapData={}//保存获取到定位信息
            //初始化地图对象，加载地图
            //初始化加载地图时，若center及level属性缺省，地图默认显示用户当前城市范围
            if(locationPx&&locationPy){
                 var map = new AMap.Map('myMap', {
                    resizeEnable: true,
                    center:position,
                    zoom: 10
                });
            }else{
               var map = new AMap.Map('myMap', {
                    resizeEnable: true,
                    zoom: 10
                });  
            }
           
            //地图中添加地图操作ToolBar插件
            map.plugin(['AMap.ToolBar'], function () {
                //设置地位标记为自定义标记
                var toolBar = new AMap.ToolBar();
                map.addControl(toolBar);
            });
            //地图中添加定位时的小标识
            var marker = new AMap.Marker({
                map: map,
                bubble: true
            });

            AMap.plugin('AMap.Geocoder', function () {
                var geocoder = new AMap.Geocoder({
                    city: "010" //城市，默认：“全国”
                });

                map.on('click', function (e) {
                    marker.setPosition(e.lnglat);
                    geocoder.getAddress(e.lnglat, function (status, result) {
                        if (status == 'complete') {
                            result.regeocode.position=e.lnglat
                            onComplete(result.regeocode)
                        }
                    })
                })

            });
            if(!(locationPx&&locationPy)){  //如果没有经纬度则初始化定位当前位置
                AMap.plugin('AMap.Geolocation', function() {
                    var geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,//是否使用高精度定位，默认:true
                        timeout: 2000,          //超过10秒后停止定位，默认：5s
                        buttonPosition:'RB',    //定位按钮的停靠位置
                        buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                        zoomToAccuracy: true   //定位成功后是否自动调整地图视野到定位点
            
                    })
                    map.addControl(geolocation)
                    geolocation.getCurrentPosition(function(status,result){
                        if(status=='complete'){
                            onComplete(result)
                        }else{
                            onError(result)
                        }
                    })
                });
            }else{
                    var lnglatXY = [locationPx,locationPy];//地图上所标点的坐标
                    AMap.service('AMap.Geocoder',function() {//回调函数
                        geocoder = new AMap.Geocoder({
                        });
                        geocoder.getAddress(lnglatXY, function (status, result) {
                            if (status === 'complete' && result.info === 'OK') {
                              onComplete(result.regeocode)
                            } else {
                                //获取地址失败
                                onError(result)
                            }
                        });
                    })
            }
            
            
            AMap.plugin('AMap.Autocomplete', function () {
                var auto = new AMap.Autocomplete({
                    input: "suggestId"
                });

                function select(e) {
                    if (e.poi && e.poi.location) {
                        locationStr = '';
                        htmlAdd = e.poi.district+e.poi.name;
                        e.poi.formattedAddress=htmlAdd
                        e.poi.position=e.poi.location
                        map.setZoom(17);
                        map.setCenter(e.poi.location);
                        marker.setPosition(e.poi.location);
                        onComplete(e.poi)
                    }
                }
                AMap.event.addListener(auto, "select", select); //注册监听，当选中某条记录时会触发
            });
            console.log(AMap,map)
            //解析定位结果
            function onComplete(data) {
                console.log(data)
                htmlAdd = data.formattedAddress;
                locationStr = htmlAdd;
                $('.locationStr').empty();
                $('.locationStr').append(htmlAdd);
                if(data.position){
                    locationPx = data.position.lng
                    locationPy = data.position.lat
                }else{
                    // data.position={}
                    // data.position.lng=locationPx
                    // data.position.lat=locationPy
                }
                    mapData=data

            }
            //解析定位错误信息
            function onError(data) {
                // alert("定位失败")
                console.log("获取定位失败:"+data.message)
                // document.getElementById('result').innerHTML = '失败原因排查信息:'+data.message;
            }
            //获取地址栏数据
            function getQueryString(name){
                 var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)');
                  var r = window.location.search.substr(1).match(reg);
                  if (r != null) {
                    return unescape(r[2]);
                  } else {
                    return null;
                  }
            }
            dom_name = getQueryString('map');
            $('#subLocat').on('click', function () {
                var offset = $('#range').val();
                if (locationStr == '' || locationStr == undefined) {
                    alert("未获取到详细地址")
                } else if (locationPy == '' || locationPy == undefined) {
                    alert("经纬度参数错误,请在地图上点击选择")
                } else if (locationPx == '' || locationPx == undefined) {
                    alert("经纬度参数错误,请在地图上点击选择")
                } else {
                    if (window.opener&&getQueryString('callback')) {
                        var callback=getQueryString('callback')
						window.close();
                        window.opener.document.getElementById(dom_name).value = locationStr;
                        window.opener[callback]&&window.opener[callback](mapData);
                    }
                }

            });
        });
    </script>
</body>

</html>