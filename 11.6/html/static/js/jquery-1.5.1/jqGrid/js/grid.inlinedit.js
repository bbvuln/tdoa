/**
 * jqGrid extension for manipulating Grid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
**/ 
//jsHint options
/*global alert, $, jQuery */
"use strict";
;(function($){$.jgrid.inlineEdit=$.jgrid.inlineEdit||{};$.jgrid.extend({editRow:function(f,g,h,j,k,l,m,n,p){var o={},args=$.makeArray(arguments).slice(1);if($.type(args[0])==="object"){o=args[0]}else{if(typeof g!=="undefined"){o.keys=g}if($.isFunction(h)){o.oneditfunc=h}if($.isFunction(j)){o.successfunc=j}if(typeof k!=="undefined"){o.url=k}if(typeof l!=="undefined"){o.extraparam=l}if($.isFunction(m)){o.aftersavefunc=m}if($.isFunction(n)){o.errorfunc=n}if($.isFunction(p)){o.afterrestorefunc=p}}o=$.extend(true,{keys:false,oneditfunc:null,successfunc:null,url:null,extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:true,mtype:"POST"},$.jgrid.inlineEdit,o);return this.each(function(){var d=this,nm,tmp,editable,cnt=0,focus=null,svr={},ind,cm;if(!d.grid){return}ind=$(d).jqGrid("getInd",f,true);if(ind===false){return}editable=$(ind).attr("editable")||"0";if(editable=="0"&&!$(ind).hasClass("not-editable-row")){cm=d.p.colModel;$('td[role="gridcell"]',ind).each(function(i){nm=cm[i].name;var a=d.p.treeGrid===true&&nm==d.p.ExpandColumn;if(a){tmp=$("span:first",this).html()}else{try{tmp=$.unformat.call(d,this,{rowId:f,colModel:cm[i]},i)}catch(_){tmp=(cm[i].edittype&&cm[i].edittype=='textarea')?$(this).text():$(this).html()}}if(nm!='cb'&&nm!='subgrid'&&nm!='rn'){if(d.p.autoencode){tmp=$.jgrid.htmlDecode(tmp)}svr[nm]=tmp;if(cm[i].editable===true){if(focus===null){focus=i}if(a){$("span:first",this).html("")}else{$(this).html("")}var b=$.extend({},cm[i].editoptions||{},{id:f+"_"+nm,name:nm});if(!cm[i].edittype){cm[i].edittype="text"}if(tmp=="&nbsp;"||tmp=="&#160;"||(tmp.length==1&&tmp.charCodeAt(0)==160)){tmp=''}var c=$.jgrid.createEl.call(d,cm[i].edittype,b,tmp,true,$.extend({},$.jgrid.ajaxOptions,d.p.ajaxSelectOptions||{}));$(c).addClass("editable");if(a){$("span:first",this).append(c)}else{$(this).append(c)}if(cm[i].edittype=="select"&&typeof(cm[i].editoptions)!=="undefined"&&cm[i].editoptions.multiple===true&&typeof(cm[i].editoptions.dataUrl)==="undefined"&&$.browser.msie){$(c).width($(c).width())}cnt++}}});if(cnt>0){svr.id=f;d.p.savedRow.push(svr);$(ind).attr("editable","1");$("td:eq("+focus+") input",ind).focus();if(o.keys===true){$(ind).bind("keydown",function(e){if(e.keyCode===27){$(d).jqGrid("restoreRow",f,o.afterrestorefunc);if(d.p._inlinenav){try{$(d).jqGrid('showAddEditButtons')}catch(eer1){}}return false}if(e.keyCode===13){var a=e.target;if(a.tagName=='TEXTAREA'){return true}if($(d).jqGrid("saveRow",f,o)){if(d.p._inlinenav){try{$(d).jqGrid('showAddEditButtons')}catch(eer2){}}}return false}})}$(d).triggerHandler("jqGridInlineEditRow",[f,o]);if($.isFunction(o.oneditfunc)){o.oneditfunc.call(d,f)}}}})},saveRow:function(d,f,g,h,j,l,m){var p=$.makeArray(arguments).slice(1),o={};if($.type(p[0])==="object"){o=p[0]}else{if($.isFunction(f)){o.successfunc=f}if(typeof g!=="undefined"){o.url=g}if(typeof h!=="undefined"){o.extraparam=h}if($.isFunction(j)){o.aftersavefunc=j}if($.isFunction(l)){o.errorfunc=l}if($.isFunction(m)){o.afterrestorefunc=m}}o=$.extend(true,{successfunc:null,url:null,extraparam:{},aftersavefunc:null,errorfunc:null,afterrestorefunc:null,restoreAfterError:true,mtype:"POST"},$.jgrid.inlineEdit,o);var q=false;var r=this[0],nm,tmp={},tmp2={},tmp3={},editable,fr,cv,ind;if(!r.grid){return q}ind=$(r).jqGrid("getInd",d,true);if(ind===false){return q}editable=$(ind).attr("editable");o.url=o.url?o.url:r.p.editurl;if(editable==="1"){var s;$('td[role="gridcell"]',ind).each(function(i){s=r.p.colModel[i];nm=s.name;if(nm!='cb'&&nm!='subgrid'&&s.editable===true&&nm!='rn'&&!$(this).hasClass('not-editable-cell')){switch(s.edittype){case"checkbox":var b=["Yes","No"];if(s.editoptions){b=s.editoptions.value.split(":")}tmp[nm]=$("input",this).is(":checked")?b[0]:b[1];break;case'text':case'password':case'textarea':case"button":tmp[nm]=$("input, textarea",this).val();break;case'select':if(!s.editoptions.multiple){tmp[nm]=$("select option:selected",this).val();tmp2[nm]=$("select option:selected",this).text()}else{var c=$("select",this),selectedText=[];tmp[nm]=$(c).val();if(tmp[nm]){tmp[nm]=tmp[nm].join(",")}else{tmp[nm]=""}$("select option:selected",this).each(function(i,a){selectedText[i]=$(a).text()});tmp2[nm]=selectedText.join(",")}if(s.formatter&&s.formatter=='select'){tmp2={}}break;case'custom':try{if(s.editoptions&&$.isFunction(s.editoptions.custom_value)){tmp[nm]=s.editoptions.custom_value.call(r,$(".customelement",this),'get');if(tmp[nm]===undefined){throw"e2";}}else{throw"e1";}}catch(e){if(e=="e1"){$.jgrid.info_dialog($.jgrid.errors.errcap,"function 'custom_value' "+$.jgrid.edit.msg.nodefined,$.jgrid.edit.bClose)}if(e=="e2"){$.jgrid.info_dialog($.jgrid.errors.errcap,"function 'custom_value' "+$.jgrid.edit.msg.novalue,$.jgrid.edit.bClose)}else{$.jgrid.info_dialog($.jgrid.errors.errcap,e.message,$.jgrid.edit.bClose)}}break}cv=$.jgrid.checkValues(tmp[nm],i,r);if(cv[0]===false){cv[1]=tmp[nm]+" "+cv[1];return false}if(r.p.autoencode){tmp[nm]=$.jgrid.htmlEncode(tmp[nm])}if(o.url!=='clientArray'&&s.editoptions&&s.editoptions.NullIfEmpty===true){if(tmp[nm]===""){tmp3[nm]='null'}}}});if(cv[0]===false){try{var t=$.jgrid.findPos($("#"+$.jgrid.jqID(d),r.grid.bDiv)[0]);$.jgrid.info_dialog($.jgrid.errors.errcap,cv[1],$.jgrid.edit.bClose,{left:t[0],top:t[1]})}catch(e){alert(cv[1])}return q}var u,opers,oper;opers=r.p.prmNames;oper=opers.oper;u=opers.id;if(tmp){tmp[oper]=opers.editoper;tmp[u]=d;if(typeof(r.p.inlineData)=='undefined'){r.p.inlineData={}}tmp=$.extend({},tmp,r.p.inlineData,o.extraparam)}if(o.url=='clientArray'){tmp=$.extend({},tmp,tmp2);if(r.p.autoencode){$.each(tmp,function(n,v){tmp[n]=$.jgrid.htmlDecode(v)})}var w=$(r).jqGrid("setRowData",d,tmp);$(ind).attr("editable","0");for(var k=0;k<r.p.savedRow.length;k++){if(r.p.savedRow[k].id==d){fr=k;break}}if(fr>=0){r.p.savedRow.splice(fr,1)}$(r).triggerHandler("jqGridInlineAfterSaveRow",[d,w,tmp,o]);if($.isFunction(o.aftersavefunc)){o.aftersavefunc.call(r,d,w)}q=true;$(ind).unbind("keydown")}else{$("#lui_"+$.jgrid.jqID(r.p.id)).show();tmp3=$.extend({},tmp,tmp3);tmp3[u]=$.jgrid.stripPref(r.p.idPrefix,tmp3[u]);$.ajax($.extend({url:o.url,data:$.isFunction(r.p.serializeRowData)?r.p.serializeRowData.call(r,tmp3):tmp3,type:o.mtype,async:false,complete:function(a,b){$("#lui_"+$.jgrid.jqID(r.p.id)).hide();if(b==="success"){var c=true,sucret;sucret=$(r).triggerHandler("jqGridInlineSuccessSaveRow",[a,d,o]);if(!$.isArray(sucret)){sucret=[true,tmp]}if(sucret[0]&&$.isFunction(o.successfunc)){sucret=o.successfunc.call(r,a)}if($.isArray(sucret)){c=sucret[0];tmp=sucret[1]?sucret[1]:tmp}else{c=sucret}if(c===true){if(r.p.autoencode){$.each(tmp,function(n,v){tmp[n]=$.jgrid.htmlDecode(v)})}tmp=$.extend({},tmp,tmp2);$(r).jqGrid("setRowData",d,tmp);$(ind).attr("editable","0");for(var k=0;k<r.p.savedRow.length;k++){if(r.p.savedRow[k].id==d){fr=k;break}}if(fr>=0){r.p.savedRow.splice(fr,1)}$(r).triggerHandler("jqGridInlineAfterSaveRow",[d,a,tmp,o]);if($.isFunction(o.aftersavefunc)){o.aftersavefunc.call(r,d,a)}q=true;$(ind).unbind("keydown")}else{$(r).triggerHandler("jqGridInlineErrorSaveRow",[d,a,b,null,o]);if($.isFunction(o.errorfunc)){o.errorfunc.call(r,d,a,b,null)}if(o.restoreAfterError===true){$(r).jqGrid("restoreRow",d,o.afterrestorefunc)}}}},error:function(a,b,c){$("#lui_"+$.jgrid.jqID(r.p.id)).hide();$(r).triggerHandler("jqGridInlineErrorSaveRow",[d,a,b,c,o]);if($.isFunction(o.errorfunc)){o.errorfunc.call(r,d,a,b,c)}else{try{$.jgrid.info_dialog($.jgrid.errors.errcap,'<div class="ui-state-error">'+a.responseText+'</div>',$.jgrid.edit.bClose,{buttonalign:'right'})}catch(e){alert(a.responseText)}}if(o.restoreAfterError===true){$(r).jqGrid("restoreRow",d,o.afterrestorefunc)}}},$.jgrid.ajaxOptions,r.p.ajaxRowOptions||{}))}}return q},restoreRow:function(b,c){var d=$.makeArray(arguments).slice(1),o={};if($.type(d[0])==="object"){o=d[0]}else{if($.isFunction(c)){o.afterrestorefunc=c}}o=$.extend(true,$.jgrid.inlineEdit,o);return this.each(function(){var a=this,fr,ind,ares={};if(!a.grid){return}ind=$(a).jqGrid("getInd",b,true);if(ind===false){return}for(var k=0;k<a.p.savedRow.length;k++){if(a.p.savedRow[k].id==b){fr=k;break}}if(fr>=0){if($.isFunction($.fn.datepicker)){try{$("input.hasDatepicker","#"+$.jgrid.jqID(ind.id)).datepicker('hide')}catch(e){}}$.each(a.p.colModel,function(){if(this.editable===true&&this.name in a.p.savedRow[fr]){ares[this.name]=a.p.savedRow[fr][this.name]}});$(a).jqGrid("setRowData",b,ares);$(ind).attr("editable","0").unbind("keydown");a.p.savedRow.splice(fr,1);if($("#"+$.jgrid.jqID(b),"#"+$.jgrid.jqID(a.p.id)).hasClass("jqgrid-new-row")){setTimeout(function(){$(a).jqGrid("delRowData",b)},0)}}$(a).triggerHandler("jqGridInlineAfterRestoreRow",[b]);if($.isFunction(o.afterrestorefunc)){o.afterrestorefunc.call(a,b)}})},addRow:function(p){p=$.extend(true,{rowID:"new_row",initdata:{},position:"first",useDefValues:true,useFormatter:false,addRowParams:{extraparam:{}}},p||{});return this.each(function(){if(!this.grid){return}var b=this;if(p.useDefValues===true){$(b.p.colModel).each(function(){if(this.editoptions&&this.editoptions.defaultValue){var a=this.editoptions.defaultValue,tmp=$.isFunction(a)?a.call(b):a;p.initdata[this.name]=tmp}})}$(b).jqGrid('addRowData',p.rowID,p.initdata,p.position);p.rowID=b.p.idPrefix+p.rowID;$("#"+$.jgrid.jqID(p.rowID),"#"+$.jgrid.jqID(b.p.id)).addClass("jqgrid-new-row");if(p.useFormatter){$("#"+$.jgrid.jqID(p.rowID)+" .ui-inline-edit","#"+$.jgrid.jqID(b.p.id)).click()}else{var c=b.p.prmNames,oper=c.oper;p.addRowParams.extraparam[oper]=c.addoper;$(b).jqGrid('editRow',p.rowID,p.addRowParams);$(b).jqGrid('setSelection',p.rowID)}})},inlineNav:function(g,o){o=$.extend({edit:true,editicon:"ui-icon-pencil",add:true,addicon:"ui-icon-plus",save:true,saveicon:"ui-icon-disk",cancel:true,cancelicon:"ui-icon-cancel",addParams:{useFormatter:false,rowID:"new_row"},editParams:{},restoreAfterSelect:true},$.jgrid.nav,o||{});return this.each(function(){if(!this.grid){return}var d=this,onSelect,gID=$.jgrid.jqID(d.p.id);d.p._inlinenav=true;if(o.addParams.useFormatter===true){var e=d.p.colModel,i;for(i=0;i<e.length;i++){if(e[i].formatter&&e[i].formatter==="actions"){if(e[i].formatoptions){var f={keys:false,onEdit:null,onSuccess:null,afterSave:null,onError:null,afterRestore:null,extraparam:{},url:null},ap=$.extend(f,e[i].formatoptions);o.addParams.addRowParams={"keys":ap.keys,"oneditfunc":ap.onEdit,"successfunc":ap.onSuccess,"url":ap.url,"extraparam":ap.extraparam,"aftersavefunc":ap.afterSavef,"errorfunc":ap.onError,"afterrestorefunc":ap.afterRestore}}break}}}if(o.add){$(d).jqGrid('navButtonAdd',g,{caption:o.addtext,title:o.addtitle,buttonicon:o.addicon,id:d.p.id+"_iladd",onClickButton:function(){$(d).jqGrid('addRow',o.addParams);if(!o.addParams.useFormatter){$("#"+gID+"_ilsave").removeClass('ui-state-disabled');$("#"+gID+"_ilcancel").removeClass('ui-state-disabled');$("#"+gID+"_iladd").addClass('ui-state-disabled');$("#"+gID+"_iledit").addClass('ui-state-disabled')}}})}if(o.edit){$(d).jqGrid('navButtonAdd',g,{caption:o.edittext,title:o.edittitle,buttonicon:o.editicon,id:d.p.id+"_iledit",onClickButton:function(){var a=$(d).jqGrid('getGridParam','selrow');if(a){$(d).jqGrid('editRow',a,o.editParams);$("#"+gID+"_ilsave").removeClass('ui-state-disabled');$("#"+gID+"_ilcancel").removeClass('ui-state-disabled');$("#"+gID+"_iladd").addClass('ui-state-disabled');$("#"+gID+"_iledit").addClass('ui-state-disabled')}else{$.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+gID,jqm:true});$("#jqg_alrt").focus()}}})}if(o.save){$(d).jqGrid('navButtonAdd',g,{caption:o.savetext||'',title:o.savetitle||'Save row',buttonicon:o.saveicon,id:d.p.id+"_ilsave",onClickButton:function(){var a=d.p.savedRow[0].id;if(a){var b=d.p.prmNames,oper=b.oper;if(!o.editParams.extraparam){o.editParams.extraparam={}}if($("#"+$.jgrid.jqID(a),"#"+gID).hasClass("jqgrid-new-row")){o.editParams.extraparam[oper]=b.addoper}else{o.editParams.extraparam[oper]=b.editoper}if($(d).jqGrid('saveRow',a,o.editParams)){$(d).jqGrid('showAddEditButtons')}}else{$.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+gID,jqm:true});$("#jqg_alrt").focus()}}});$("#"+gID+"_ilsave").addClass('ui-state-disabled')}if(o.cancel){$(d).jqGrid('navButtonAdd',g,{caption:o.canceltext||'',title:o.canceltitle||'Cancel row editing',buttonicon:o.cancelicon,id:d.p.id+"_ilcancel",onClickButton:function(){var a=d.p.savedRow[0].id;if(a){$(d).jqGrid('restoreRow',a,o.editParams);$(d).jqGrid('showAddEditButtons')}else{$.jgrid.viewModal("#alertmod",{gbox:"#gbox_"+gID,jqm:true});$("#jqg_alrt").focus()}}});$("#"+gID+"_ilcancel").addClass('ui-state-disabled')}if(o.restoreAfterSelect===true){if($.isFunction(d.p.beforeSelectRow)){onSelect=d.p.beforeSelectRow}else{onSelect=false}d.p.beforeSelectRow=function(a,b){var c=true;if(d.p.savedRow.length>0&&d.p._inlinenav===true&&(a!==d.p.selrow&&d.p.selrow!==null)){if(d.p.selrow==o.addParams.rowID){$(d).jqGrid('delRowData',d.p.selrow)}else{$(d).jqGrid('restoreRow',d.p.selrow,o.editParams)}$(d).jqGrid('showAddEditButtons')}if(onSelect){c=onSelect.call(d,a,b)}return c}}})},showAddEditButtons:function(){return this.each(function(){if(!this.grid){return}var a=$.jgrid.jqID(this.p.id);$("#"+a+"_ilsave").addClass('ui-state-disabled');$("#"+a+"_ilcancel").addClass('ui-state-disabled');$("#"+a+"_iladd").removeClass('ui-state-disabled');$("#"+a+"_iledit").removeClass('ui-state-disabled')})}})})(jQuery);
