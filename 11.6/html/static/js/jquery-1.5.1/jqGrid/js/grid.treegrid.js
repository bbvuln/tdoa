/**
 * jqGrid extension - Tree Grid
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
**/

/*global document, jQuery, $ */
"use strict";
(function($){$.jgrid.extend({setTreeNode:function(i,g){return this.each(function(){var b=this;if(!b.grid||!b.p.treeGrid){return}var c=b.p.expColInd,expanded=b.p.treeReader.expanded_field,isLeaf=b.p.treeReader.leaf_field,level=b.p.treeReader.level_field,icon=b.p.treeReader.icon_field,loaded=b.p.treeReader.loaded,lft,rgt,curLevel,ident,lftpos,twrap,ldat,lf;while(i<g){var d=b.rows[i].id,dind=b.p._index[d],expan;ldat=b.p.data[dind];if(b.p.treeGridModel=='nested'){if(!ldat[isLeaf]){lft=parseInt(ldat[b.p.treeReader.left_field],10);rgt=parseInt(ldat[b.p.treeReader.right_field],10);ldat[isLeaf]=(rgt===lft+1)?'true':'false';b.rows[i].cells[b.p._treeleafpos].innerHTML=ldat[isLeaf]}}curLevel=parseInt(ldat[level],10);if(b.p.tree_root_level===0){ident=curLevel+1;lftpos=curLevel}else{ident=curLevel;lftpos=curLevel-1}twrap="<div class='tree-wrap tree-wrap-"+b.p.direction+"' style='width:"+(ident*18)+"px;'>";twrap+="<div style='"+(b.p.direction=="rtl"?"right:":"left:")+(lftpos*18)+"px;' class='ui-icon ";if(ldat[loaded]!==undefined){if(ldat[loaded]=="true"||ldat[loaded]===true){ldat[loaded]=true}else{ldat[loaded]=false}}if(ldat[isLeaf]=="true"||ldat[isLeaf]===true){twrap+=((ldat[icon]!==undefined&&ldat[icon]!=="")?ldat[icon]:b.p.treeIcons.leaf)+" tree-leaf treeclick";ldat[isLeaf]=true;lf="leaf"}else{ldat[isLeaf]=false;lf=""}ldat[expanded]=((ldat[expanded]=="true"||ldat[expanded]===true)?true:false)&&ldat[loaded];if(ldat[expanded]===false){twrap+=((ldat[isLeaf]===true)?"'":b.p.treeIcons.plus+" tree-plus treeclick'")}else{twrap+=((ldat[isLeaf]===true)?"'":b.p.treeIcons.minus+" tree-minus treeclick'")}twrap+="></div></div>";$(b.rows[i].cells[c]).wrapInner("<span class='cell-wrapper"+lf+"'></span>").prepend(twrap);if(curLevel!==parseInt(b.p.tree_root_level,10)){var f=$(b).jqGrid('getNodeParent',ldat);expan=f&&f.hasOwnProperty(expanded)?f[expanded]:true;if(!expan){$(b.rows[i]).css("display","none")}}$(b.rows[i].cells[c]).find("div.treeclick").bind("click",function(e){var a=e.target||e.srcElement,ind2=$(a,b.rows).closest("tr.jqgrow")[0].id,pos=b.p._index[ind2];if(!b.p.data[pos][isLeaf]){if(b.p.data[pos][expanded]){$(b).jqGrid("collapseRow",b.p.data[pos]);$(b).jqGrid("collapseNode",b.p.data[pos])}else{$(b).jqGrid("expandRow",b.p.data[pos]);$(b).jqGrid("expandNode",b.p.data[pos])}}return false});if(b.p.ExpandColClick===true){$(b.rows[i].cells[c]).find("span.cell-wrapper").css("cursor","pointer").bind("click",function(e){var a=e.target||e.srcElement,ind2=$(a,b.rows).closest("tr.jqgrow")[0].id,pos=b.p._index[ind2];if(!b.p.data[pos][isLeaf]){if(b.p.data[pos][expanded]){$(b).jqGrid("collapseRow",b.p.data[pos]);$(b).jqGrid("collapseNode",b.p.data[pos])}else{$(b).jqGrid("expandRow",b.p.data[pos]);$(b).jqGrid("expandNode",b.p.data[pos])}}$(b).jqGrid("setSelection",ind2);return false})}i++}})},setTreeGrid:function(){return this.each(function(){var a=this,i=0,pico,ecol=false,nm,key,dupcols=[];if(!a.p.treeGrid){return}if(!a.p.treedatatype){$.extend(a.p,{treedatatype:a.p.datatype})}a.p.subGrid=false;a.p.altRows=false;a.p.pgbuttons=false;a.p.pginput=false;a.p.gridview=true;if(a.p.rowTotal===null){a.p.rowNum=10000}a.p.multiselect=false;a.p.rowList=[];a.p.expColInd=0;pico='ui-icon-triangle-1-'+(a.p.direction=="rtl"?'w':'e');a.p.treeIcons=$.extend({plus:pico,minus:'ui-icon-triangle-1-s',leaf:'ui-icon-radio-off'},a.p.treeIcons||{});if(a.p.treeGridModel=='nested'){a.p.treeReader=$.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},a.p.treeReader)}else if(a.p.treeGridModel=='adjacency'){a.p.treeReader=$.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},a.p.treeReader)}for(key in a.p.colModel){if(a.p.colModel.hasOwnProperty(key)){nm=a.p.colModel[key].name;if(nm==a.p.ExpandColumn&&!ecol){ecol=true;a.p.expColInd=i}i++;for(var b in a.p.treeReader){if(a.p.treeReader[b]==nm){dupcols.push(nm)}}}}$.each(a.p.treeReader,function(j,n){if(n&&$.inArray(n,dupcols)===-1){if(j==='leaf_field'){a.p._treeleafpos=i}i++;a.p.colNames.push(n);a.p.colModel.push({name:n,width:1,hidden:true,sortable:false,resizable:false,hidedlg:true,editable:true,search:false})}})})},expandRow:function(d){this.each(function(){var b=this;if(!b.grid||!b.p.treeGrid){return}var c=$(b).jqGrid("getNodeChildren",d),expanded=b.p.treeReader.expanded_field,rows=b.rows;$(c).each(function(){var a=$.jgrid.getAccessor(this,b.p.localReader.id);$(rows.namedItem(a)).css("display","");if(this[expanded]){$(b).jqGrid("expandRow",this)}})})},collapseRow:function(d){this.each(function(){var b=this;if(!b.grid||!b.p.treeGrid){return}var c=$(b).jqGrid("getNodeChildren",d),expanded=b.p.treeReader.expanded_field,rows=b.rows;$(c).each(function(){var a=$.jgrid.getAccessor(this,b.p.localReader.id);$(rows.namedItem(a)).css("display","none");if(this[expanded]){$(b).jqGrid("collapseRow",this)}})})},getRootNodes:function(){var d=[];this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}switch(a.p.treeGridModel){case'nested':var b=a.p.treeReader.level_field;$(a.p.data).each(function(){if(parseInt(this[b],10)===parseInt(a.p.tree_root_level,10)){d.push(this)}});break;case'adjacency':var c=a.p.treeReader.parent_id_field;$(a.p.data).each(function(){if(this[c]===null||String(this[c]).toLowerCase()=="null"){d.push(this)}});break}});return d},getNodeDepth:function(c){var d=null;this.each(function(){if(!this.grid||!this.p.treeGrid){return}var a=this;switch(a.p.treeGridModel){case'nested':var b=a.p.treeReader.level_field;d=parseInt(c[b],10)-parseInt(a.p.tree_root_level,10);break;case'adjacency':d=$(a).jqGrid("getNodeAncestors",c).length;break}});return d},getNodeParent:function(d){var e=null;this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}switch(a.p.treeGridModel){case'nested':var b=a.p.treeReader.left_field,rgtc=a.p.treeReader.right_field,levelc=a.p.treeReader.level_field,lft=parseInt(d[b],10),rgt=parseInt(d[rgtc],10),level=parseInt(d[levelc],10);$(this.p.data).each(function(){if(parseInt(this[levelc],10)===level-1&&parseInt(this[b],10)<lft&&parseInt(this[rgtc],10)>rgt){e=this;return false}});break;case'adjacency':var c=a.p.treeReader.parent_id_field,dtid=a.p.localReader.id;$(this.p.data).each(function(){if(this[dtid]==d[c]){e=this;return false}});break}});return e},getNodeChildren:function(d){var e=[];this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}switch(a.p.treeGridModel){case'nested':var b=a.p.treeReader.left_field,rgtc=a.p.treeReader.right_field,levelc=a.p.treeReader.level_field,lft=parseInt(d[b],10),rgt=parseInt(d[rgtc],10),level=parseInt(d[levelc],10);$(this.p.data).each(function(){if(parseInt(this[levelc],10)===level+1&&parseInt(this[b],10)>lft&&parseInt(this[rgtc],10)<rgt){e.push(this)}});break;case'adjacency':var c=a.p.treeReader.parent_id_field,dtid=a.p.localReader.id;$(this.p.data).each(function(){if(this[c]==d[dtid]){e.push(this)}});break}});return e},getFullTreeNode:function(d){var e=[];this.each(function(){var a=this,len;if(!a.grid||!a.p.treeGrid){return}switch(a.p.treeGridModel){case'nested':var b=a.p.treeReader.left_field,rgtc=a.p.treeReader.right_field,levelc=a.p.treeReader.level_field,lft=parseInt(d[b],10),rgt=parseInt(d[rgtc],10),level=parseInt(d[levelc],10);$(this.p.data).each(function(){if(parseInt(this[levelc],10)>=level&&parseInt(this[b],10)>=lft&&parseInt(this[b],10)<=rgt){e.push(this)}});break;case'adjacency':if(d){e.push(d);var c=a.p.treeReader.parent_id_field,dtid=a.p.localReader.id;$(this.p.data).each(function(i){len=e.length;for(i=0;i<len;i++){if(e[i][dtid]==this[c]){e.push(this);break}}})}break}});return e},getNodeAncestors:function(b){var c=[];this.each(function(){if(!this.grid||!this.p.treeGrid){return}var a=$(this).jqGrid("getNodeParent",b);while(a){c.push(a);a=$(this).jqGrid("getNodeParent",a)}});return c},isVisibleNode:function(c){var d=true;this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}var b=$(a).jqGrid("getNodeAncestors",c),expanded=a.p.treeReader.expanded_field;$(b).each(function(){d=d&&this[expanded];if(!d){return false}})});return d},isNodeLoaded:function(c){var d;this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}var b=a.p.treeReader.leaf_field;if(c!==undefined){if(c.loaded!==undefined){d=c.loaded}else if(c[b]||$(a).jqGrid("getNodeChildren",c).length>0){d=true}else{d=false}}else{d=false}});return d},expandNode:function(e){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var a=this.p.treeReader.expanded_field,parent=this.p.treeReader.parent_id_field,loaded=this.p.treeReader.loaded,level=this.p.treeReader.level_field,lft=this.p.treeReader.left_field,rgt=this.p.treeReader.right_field;if(!e[a]){var b=$.jgrid.getAccessor(e,this.p.localReader.id);var c=$("#"+$.jgrid.jqID(b),this.grid.bDiv)[0];var d=this.p._index[b];if($(this).jqGrid("isNodeLoaded",this.p.data[d])){e[a]=true;$("div.treeclick",c).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")}else if(!this.grid.hDiv.loading){e[a]=true;$("div.treeclick",c).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus");this.p.treeANode=c.rowIndex;this.p.datatype=this.p.treedatatype;if(this.p.treeGridModel=='nested'){$(this).jqGrid("setGridParam",{postData:{nodeid:b,n_left:e[lft],n_right:e[rgt],n_level:e[level]}})}else{$(this).jqGrid("setGridParam",{postData:{nodeid:b,parentid:e[parent],n_level:e[level]}})}$(this).trigger("reloadGrid");e[loaded]=true;if(this.p.treeGridModel=='nested'){$(this).jqGrid("setGridParam",{postData:{nodeid:'',n_left:'',n_right:'',n_level:''}})}else{$(this).jqGrid("setGridParam",{postData:{nodeid:'',parentid:'',n_level:''}})}}}})},collapseNode:function(d){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var a=this.p.treeReader.expanded_field;if(d[a]){d[a]=false;var b=$.jgrid.getAccessor(d,this.p.localReader.id);var c=$("#"+$.jgrid.jqID(b),this.grid.bDiv)[0];$("div.treeclick",c).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}})},SortTree:function(c,d,e,f){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var i,len,rec,records=[],$t=this,query,roots,rt=$(this).jqGrid("getRootNodes");query=$.jgrid.from(rt);query.orderBy(c,d,e,f);roots=query.select();for(i=0,len=roots.length;i<len;i++){rec=roots[i];records.push(rec);$(this).jqGrid("collectChildrenSortTree",records,rec,c,d,e,f)}$.each(records,function(a){var b=$.jgrid.getAccessor(this,$t.p.localReader.id);$('#'+$.jgrid.jqID($t.p.id)+' tbody tr:eq('+a+')').after($('tr#'+$.jgrid.jqID(b),$t.grid.bDiv))});query=null;roots=null;records=null})},collectChildrenSortTree:function(a,b,c,d,e,f){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var i,len,child,ch,query,children;ch=$(this).jqGrid("getNodeChildren",b);query=$.jgrid.from(ch);query.orderBy(c,d,e,f);children=query.select();for(i=0,len=children.length;i<len;i++){child=children[i];a.push(child);$(this).jqGrid("collectChildrenSortTree",a,child,c,d,e,f)}})},setTreeRow:function(a,b){var c=false;this.each(function(){var t=this;if(!t.grid||!t.p.treeGrid){return}c=$(t).jqGrid("setRowData",a,b)});return c},delTreeNode:function(d){return this.each(function(){var a=this,rid=a.p.localReader.id,left=a.p.treeReader.left_field,right=a.p.treeReader.right_field,myright,width,res,key;if(!a.grid||!a.p.treeGrid){return}var b=a.p._index[d];if(b!==undefined){myright=parseInt(a.p.data[b][right],10);width=myright-parseInt(a.p.data[b][left],10)+1;var c=$(a).jqGrid("getFullTreeNode",a.p.data[b]);if(c.length>0){for(var i=0;i<c.length;i++){$(a).jqGrid("delRowData",c[i][rid])}}if(a.p.treeGridModel==="nested"){res=$.jgrid.from(a.p.data).greater(left,myright,{stype:'integer'}).select();if(res.length){for(key in res){if(res.hasOwnProperty(key)){res[key][left]=parseInt(res[key][left],10)-width}}}res=$.jgrid.from(a.p.data).greater(right,myright,{stype:'integer'}).select();if(res.length){for(key in res){if(res.hasOwnProperty(key)){res[key][right]=parseInt(res[key][right],10)-width}}}}}})},addChildNode:function(a,b,c){var d=this[0];if(c){var e=d.p.treeReader.expanded_field,isLeaf=d.p.treeReader.leaf_field,level=d.p.treeReader.level_field,parent=d.p.treeReader.parent_id_field,left=d.p.treeReader.left_field,right=d.p.treeReader.right_field,loaded=d.p.treeReader.loaded,method,parentindex,parentdata,parentlevel,i,len,max=0,rowind=b,leaf,maxright;if(typeof a==='undefined'||a===null){i=d.p.data.length-1;if(i>=0){while(i>=0){max=Math.max(max,parseInt(d.p.data[i][d.p.localReader.id],10));i--}}a=max+1}var f=$(d).jqGrid('getInd',b);leaf=false;if(b===undefined||b===null||b===""){b=null;rowind=null;method='last';parentlevel=d.p.tree_root_level;i=d.p.data.length+1}else{method='after';parentindex=d.p._index[b];parentdata=d.p.data[parentindex];b=parentdata[d.p.localReader.id];parentlevel=parseInt(parentdata[level],10)+1;var g=$(d).jqGrid('getFullTreeNode',parentdata);if(g.length){i=g[g.length-1][d.p.localReader.id];rowind=i;i=$(d).jqGrid('getInd',rowind)+1}else{i=$(d).jqGrid('getInd',b)+1}if(parentdata[isLeaf]){leaf=true;parentdata[e]=true;$(d.rows[f]).find("span.cell-wrapperleaf").removeClass("cell-wrapperleaf").addClass("cell-wrapper").end().find("div.tree-leaf").removeClass(d.p.treeIcons.leaf+" tree-leaf").addClass(d.p.treeIcons.minus+" tree-minus");d.p.data[parentindex][isLeaf]=false;parentdata[loaded]=true}}len=i+1;c[e]=false;c[loaded]=true;c[level]=parentlevel;c[isLeaf]=true;if(d.p.treeGridModel==="adjacency"){c[parent]=b}if(d.p.treeGridModel==="nested"){var h,res,key;if(b!==null){maxright=parseInt(parentdata[right],10);h=$.jgrid.from(d.p.data);h=h.greaterOrEquals(right,maxright,{stype:'integer'});res=h.select();if(res.length){for(key in res){if(res.hasOwnProperty(key)){res[key][left]=res[key][left]>maxright?parseInt(res[key][left],10)+2:res[key][left];res[key][right]=res[key][right]>=maxright?parseInt(res[key][right],10)+2:res[key][right]}}}c[left]=maxright;c[right]=maxright+1}else{maxright=parseInt($(d).jqGrid('getCol',right,false,'max'),10);res=$.jgrid.from(d.p.data).greater(left,maxright,{stype:'integer'}).select();if(res.length){for(key in res){if(res.hasOwnProperty(key)){res[key][left]=parseInt(res[key][left],10)+2}}}res=$.jgrid.from(d.p.data).greater(right,maxright,{stype:'integer'}).select();if(res.length){for(key in res){if(res.hasOwnProperty(key)){res[key][right]=parseInt(res[key][right],10)+2}}}c[left]=maxright+1;c[right]=maxright+2}}if(b===null||$(d).jqGrid("isNodeLoaded",parentdata)||leaf){$(d).jqGrid('addRowData',a,c,method,rowind);$(d).jqGrid('setTreeNode',i,len)}if(parentdata&&!parentdata[e]){$(d.rows[f]).find("div.treeclick").click()}}}})})(jQuery);
