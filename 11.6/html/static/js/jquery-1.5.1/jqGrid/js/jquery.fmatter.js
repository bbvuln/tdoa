/*
**
 * formatter for values but most of the values if for jqGrid
 * Some of this was inspired and based on how YUI does the table datagrid but in jQuery fashion
 * we are trying to keep it as light as possible
 * Joshua Burnett josh@9ci.com	
 * http://www.greenbill.com
 *
 * Changes from Tony Tomov tony@trirand.com
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
 * 
**/
"use strict";
;(function($){$.fmatter={};$.extend($.fmatter,{isBoolean:function(o){return typeof o==='boolean'},isObject:function(o){return(o&&(typeof o==='object'||$.isFunction(o)))||false},isString:function(o){return typeof o==='string'},isNumber:function(o){return typeof o==='number'&&isFinite(o)},isNull:function(o){return o===null},isUndefined:function(o){return typeof o==='undefined'},isValue:function(o){return(this.isObject(o)||this.isString(o)||this.isNumber(o)||this.isBoolean(o))},isEmpty:function(o){if(!this.isString(o)&&this.isValue(o)){return false}else if(!this.isValue(o)){return true}o=$.trim(o).replace(/\&nbsp\;/ig,'').replace(/\&#160\;/ig,'');return o===""}});$.fn.fmatter=function(a,b,c,d,e){var v=b;c=$.extend({},$.jgrid.formatter,c);try{v=$.fn.fmatter[a].call(this,b,c,d,e)}catch(fe){}return v};$.fmatter.util={NumberFormat:function(a,b){if(!$.fmatter.isNumber(a)){a*=1}if($.fmatter.isNumber(a)){var c=(a<0);var d=a+"";var e=(b.decimalSeparator)?b.decimalSeparator:".";var f;if($.fmatter.isNumber(b.decimalPlaces)){var g=b.decimalPlaces;var h=Math.pow(10,g);d=Math.round(a*h)/h+"";f=d.lastIndexOf(".");if(g>0){if(f<0){d+=e;f=d.length-1}else if(e!=="."){d=d.replace(".",e)}while((d.length-1-f)<g){d+="0"}}}if(b.thousandsSeparator){var j=b.thousandsSeparator;f=d.lastIndexOf(e);f=(f>-1)?f:d.length;var k=d.substring(f);var l=-1;for(var i=f;i>0;i--){l++;if((l%3===0)&&(i!==f)&&(!c||(i>1))){k=j+k}k=d.charAt(i-1)+k}d=k}d=(b.prefix)?b.prefix+d:d;d=(b.suffix)?d+b.suffix:d;return d}else{return a}},DateFormat:function(c,d,e,f){var g=/\\.|[dDjlNSwzWFmMntLoYyaABgGhHisueIOPTZcrU]/g,timezone=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,timezoneClip=/[^-+\dA-Z]/g,msDateRegExp=new RegExp("^\/Date\\((([-+])?[0-9]+)(([-+])([0-9]{2})([0-9]{2}))?\\)\/$"),msMatch=((typeof d==='string')?d.match(msDateRegExp):null),pad=function(a,b){a=String(a);b=parseInt(b,10)||2;while(a.length<b){a='0'+a}return a},ts={m:1,d:1,y:1970,h:0,i:0,s:0,u:0},timestamp=0,dM,k,hl,dateFormat=["i18n"];dateFormat.i18n={dayNames:f.dayNames,monthNames:f.monthNames};if(c in f.masks){c=f.masks[c]}if(!isNaN(d-0)&&String(c).toLowerCase()=="u"){timestamp=new Date(parseFloat(d)*1000)}else if(d.constructor===Date){timestamp=d}else if(msMatch!==null){timestamp=new Date(parseInt(msMatch[1],10));if(msMatch[3]){var h=Number(msMatch[5])*60+Number(msMatch[6]);h*=((msMatch[4]=='-')?1:-1);h-=timestamp.getTimezoneOffset();timestamp.setTime(Number(Number(timestamp)+(h*60*1000)))}}else{d=String(d).split(/[\\\/:_;.,\t\T\s-]/);c=c.split(/[\\\/:_;.,\t\T\s-]/);for(k=0,hl=c.length;k<hl;k++){if(c[k]=='M'){dM=$.inArray(d[k],dateFormat.i18n.monthNames);if(dM!==-1&&dM<12){d[k]=dM+1}}if(c[k]=='F'){dM=$.inArray(d[k],dateFormat.i18n.monthNames);if(dM!==-1&&dM>11){d[k]=dM+1-12}}if(d[k]){ts[c[k].toLowerCase()]=parseInt(d[k],10)}}if(ts.f){ts.m=ts.f}if(ts.m===0&&ts.y===0&&ts.d===0){return"&#160;"}ts.m=parseInt(ts.m,10)-1;var l=ts.y;if(l>=70&&l<=99){ts.y=1900+ts.y}else if(l>=0&&l<=69){ts.y=2000+ts.y}timestamp=new Date(ts.y,ts.m,ts.d,ts.h,ts.i,ts.s,ts.u)}if(e in f.masks){e=f.masks[e]}else if(!e){e='Y-m-d'}var G=timestamp.getHours(),i=timestamp.getMinutes(),j=timestamp.getDate(),n=timestamp.getMonth()+1,o=timestamp.getTimezoneOffset(),s=timestamp.getSeconds(),u=timestamp.getMilliseconds(),w=timestamp.getDay(),Y=timestamp.getFullYear(),N=(w+6)%7+1,z=(new Date(Y,n-1,j)-new Date(Y,0,1))/86400000,flags={d:pad(j),D:dateFormat.i18n.dayNames[w],j:j,l:dateFormat.i18n.dayNames[w+7],N:N,S:f.S(j),w:w,z:z,W:N<5?Math.floor((z+N-1)/7)+1:Math.floor((z+N-1)/7)||((new Date(Y-1,0,1).getDay()+6)%7<4?53:52),F:dateFormat.i18n.monthNames[n-1+12],m:pad(n),M:dateFormat.i18n.monthNames[n-1],n:n,t:'?',L:'?',o:'?',Y:Y,y:String(Y).substring(2),a:G<12?f.AmPm[0]:f.AmPm[1],A:G<12?f.AmPm[2]:f.AmPm[3],B:'?',g:G%12||12,G:G,h:pad(G%12||12),H:pad(G),i:pad(i),s:pad(s),u:u,e:'?',I:'?',O:(o>0?"-":"+")+pad(Math.floor(Math.abs(o)/60)*100+Math.abs(o)%60,4),P:'?',T:(String(timestamp).match(timezone)||[""]).pop().replace(timezoneClip,""),Z:'?',c:'?',r:'?',U:Math.floor(timestamp/1000)};return e.replace(g,function(a){return a in flags?flags[a]:a.substring(1)})}};$.fn.fmatter.defaultFormat=function(a,b){return($.fmatter.isValue(a)&&a!=="")?a:b.defaultValue?b.defaultValue:"&#160;"};$.fn.fmatter.email=function(a,b){if(!$.fmatter.isEmpty(a)){return"<a href=\"mailto:"+a+"\">"+a+"</a>"}else{return $.fn.fmatter.defaultFormat(a,b)}};$.fn.fmatter.checkbox=function(a,b){var c=$.extend({},b.checkbox),ds;if(b.colModel!==undefined&&!$.fmatter.isUndefined(b.colModel.formatoptions)){c=$.extend({},c,b.colModel.formatoptions)}if(c.disabled===true){ds="disabled=\"disabled\""}else{ds=""}if($.fmatter.isEmpty(a)||$.fmatter.isUndefined(a)){a=$.fn.fmatter.defaultFormat(a,c)}a=a+"";a=a.toLowerCase();var d=a.search(/(false|0|no|off)/i)<0?" checked='checked' ":"";return"<input type=\"checkbox\" "+d+" value=\""+a+"\" offval=\"no\" "+ds+"/>"};$.fn.fmatter.link=function(a,b){var c={target:b.target};var d="";if(b.colModel!==undefined&&!$.fmatter.isUndefined(b.colModel.formatoptions)){c=$.extend({},c,b.colModel.formatoptions)}if(c.target){d='target='+c.target}if(!$.fmatter.isEmpty(a)){return"<a "+d+" href=\""+a+"\">"+a+"</a>"}else{return $.fn.fmatter.defaultFormat(a,b)}};$.fn.fmatter.showlink=function(a,b){var c={baseLinkUrl:b.baseLinkUrl,showAction:b.showAction,addParam:b.addParam||"",target:b.target,idName:b.idName},target="",idUrl;if(b.colModel!==undefined&&!$.fmatter.isUndefined(b.colModel.formatoptions)){c=$.extend({},c,b.colModel.formatoptions)}if(c.target){target='target='+c.target}idUrl=c.baseLinkUrl+c.showAction+'?'+c.idName+'='+b.rowId+c.addParam;if($.fmatter.isString(a)||$.fmatter.isNumber(a)){return"<a "+target+" href=\""+idUrl+"\">"+a+"</a>"}else{return $.fn.fmatter.defaultFormat(a,b)}};$.fn.fmatter.integer=function(a,b){var c=$.extend({},b.integer);if(b.colModel!==undefined&&!$.fmatter.isUndefined(b.colModel.formatoptions)){c=$.extend({},c,b.colModel.formatoptions)}if($.fmatter.isEmpty(a)){return c.defaultValue}return $.fmatter.util.NumberFormat(a,c)};$.fn.fmatter.number=function(a,b){var c=$.extend({},b.number);if(b.colModel!==undefined&&!$.fmatter.isUndefined(b.colModel.formatoptions)){c=$.extend({},c,b.colModel.formatoptions)}if($.fmatter.isEmpty(a)){return c.defaultValue}return $.fmatter.util.NumberFormat(a,c)};$.fn.fmatter.currency=function(a,b){var c=$.extend({},b.currency);if(b.colModel!==undefined&&!$.fmatter.isUndefined(b.colModel.formatoptions)){c=$.extend({},c,b.colModel.formatoptions)}if($.fmatter.isEmpty(a)){return c.defaultValue}return $.fmatter.util.NumberFormat(a,c)};$.fn.fmatter.date=function(a,b,c,d){var e=$.extend({},b.date);if(b.colModel!==undefined&&!$.fmatter.isUndefined(b.colModel.formatoptions)){e=$.extend({},e,b.colModel.formatoptions)}if(!e.reformatAfterEdit&&d=='edit'){return $.fn.fmatter.defaultFormat(a,b)}else if(!$.fmatter.isEmpty(a)){return $.fmatter.util.DateFormat(e.srcformat,a,e.newformat,e)}else{return $.fn.fmatter.defaultFormat(a,b)}};$.fn.fmatter.select=function(a,b){a=a+"";var c=false,ret=[],sep,delim;if(!$.fmatter.isUndefined(b.colModel.formatoptions)){c=b.colModel.formatoptions.value;sep=b.colModel.formatoptions.separator===undefined?":":b.colModel.formatoptions.separator;delim=b.colModel.formatoptions.delimiter===undefined?";":b.colModel.formatoptions.delimiter}else if(!$.fmatter.isUndefined(b.colModel.editoptions)){c=b.colModel.editoptions.value;sep=b.colModel.editoptions.separator===undefined?":":b.colModel.editoptions.separator;delim=b.colModel.editoptions.delimiter===undefined?";":b.colModel.editoptions.delimiter}if(c){var d=b.colModel.editoptions.multiple===true?true:false,scell=[],sv;if(d){scell=a.split(",");scell=$.map(scell,function(n){return $.trim(n)})}if($.fmatter.isString(c)){var e=c.split(delim),j=0;for(var i=0;i<e.length;i++){sv=e[i].split(sep);if(sv.length>2){sv[1]=$.map(sv,function(n,i){if(i>0){return n}}).join(sep)}if(d){if($.inArray(sv[0],scell)>-1){ret[j]=sv[1];j++}}else if($.trim(sv[0])==$.trim(a)){ret[0]=sv[1];break}}}else if($.fmatter.isObject(c)){if(d){ret=$.map(scell,function(n){return c[n]})}else{ret[0]=c[a]||""}}}a=ret.join(", ");return a===""?$.fn.fmatter.defaultFormat(a,b):a};$.fn.fmatter.rowactions=function(c,d,e,f){var g={keys:false,onEdit:null,onSuccess:null,afterSave:null,onError:null,afterRestore:null,extraparam:{},url:null,restoreAfterError:true,mtype:"POST",delOptions:{},editOptions:{}};c=$.jgrid.jqID(c);d=$.jgrid.jqID(d);var h=$('#'+d)[0].p.colModel[f];if(!$.fmatter.isUndefined(h.formatoptions)){g=$.extend(g,h.formatoptions)}if(!$.fmatter.isUndefined($('#'+d)[0].p.editOptions)){g.editOptions=$('#'+d)[0].p.editOptions}if(!$.fmatter.isUndefined($('#'+d)[0].p.delOptions)){g.delOptions=$('#'+d)[0].p.delOptions}var i=$("#"+d)[0];var j=function(a,b){if($.isFunction(g.afterSave)){g.afterSave.call(i,a,b)}$("tr#"+c+" div.ui-inline-edit, "+"tr#"+c+" div.ui-inline-del","#"+d+".ui-jqgrid-btable:first").show();$("tr#"+c+" div.ui-inline-save, "+"tr#"+c+" div.ui-inline-cancel","#"+d+".ui-jqgrid-btable:first").hide()},restorerow=function(a){if($.isFunction(g.afterRestore)){g.afterRestore.call(i,a)}$("tr#"+c+" div.ui-inline-edit, "+"tr#"+c+" div.ui-inline-del","#"+d+".ui-jqgrid-btable:first").show();$("tr#"+c+" div.ui-inline-save, "+"tr#"+c+" div.ui-inline-cancel","#"+d+".ui-jqgrid-btable:first").hide()};if($("#"+c,"#"+d).hasClass("jqgrid-new-row")){var k=i.p.prmNames,oper=k.oper;g.extraparam[oper]=k.addoper}var l={keys:g.keys,oneditfunc:g.onEdit,successfunc:g.onSuccess,url:g.url,extraparam:g.extraparam,aftersavefunc:j,errorfunc:g.onError,afterrestorefunc:restorerow,restoreAfterError:g.restoreAfterError,mtype:g.mtype};switch(e){case'edit':$('#'+d).jqGrid('editRow',c,l);$("tr#"+c+" div.ui-inline-edit, "+"tr#"+c+" div.ui-inline-del","#"+d+".ui-jqgrid-btable:first").hide();$("tr#"+c+" div.ui-inline-save, "+"tr#"+c+" div.ui-inline-cancel","#"+d+".ui-jqgrid-btable:first").show();$(i).triggerHandler("jqGridAfterGridComplete");break;case'save':if($('#'+d).jqGrid('saveRow',c,l)){$("tr#"+c+" div.ui-inline-edit, "+"tr#"+c+" div.ui-inline-del","#"+d+".ui-jqgrid-btable:first").show();$("tr#"+c+" div.ui-inline-save, "+"tr#"+c+" div.ui-inline-cancel","#"+d+".ui-jqgrid-btable:first").hide();$(i).triggerHandler("jqGridAfterGridComplete")}break;case'cancel':$('#'+d).jqGrid('restoreRow',c,restorerow);$("tr#"+c+" div.ui-inline-edit, "+"tr#"+c+" div.ui-inline-del","#"+d+".ui-jqgrid-btable:first").show();$("tr#"+c+" div.ui-inline-save, "+"tr#"+c+" div.ui-inline-cancel","#"+d+".ui-jqgrid-btable:first").hide();$(i).triggerHandler("jqGridAfterGridComplete");break;case'del':$('#'+d).jqGrid('delGridRow',c,g.delOptions);break;case'formedit':$('#'+d).jqGrid('setSelection',c);$('#'+d).jqGrid('editGridRow',c,g.editOptions);break}};$.fn.fmatter.actions=function(a,b){var c={keys:false,editbutton:true,delbutton:true,editformbutton:false};if(!$.fmatter.isUndefined(b.colModel.formatoptions)){c=$.extend(c,b.colModel.formatoptions)}var d=b.rowId,str="",ocl;if(typeof(d)=='undefined'||$.fmatter.isEmpty(d)){return""}if(c.editformbutton){ocl="onclick=jQuery.fn.fmatter.rowactions('"+d+"','"+b.gid+"','formedit',"+b.pos+"); onmouseover=jQuery(this).addClass('ui-state-hover'); onmouseout=jQuery(this).removeClass('ui-state-hover'); ";str=str+"<div title='"+$.jgrid.nav.edittitle+"' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit' "+ocl+"><span class='ui-icon ui-icon-pencil'></span></div>"}else if(c.editbutton){ocl="onclick=jQuery.fn.fmatter.rowactions('"+d+"','"+b.gid+"','edit',"+b.pos+"); onmouseover=jQuery(this).addClass('ui-state-hover'); onmouseout=jQuery(this).removeClass('ui-state-hover') ";str=str+"<div title='"+$.jgrid.nav.edittitle+"' style='float:left;cursor:pointer;' class='ui-pg-div ui-inline-edit' "+ocl+"><span class='ui-icon ui-icon-pencil'></span></div>"}if(c.delbutton){ocl="onclick=jQuery.fn.fmatter.rowactions('"+d+"','"+b.gid+"','del',"+b.pos+"); onmouseover=jQuery(this).addClass('ui-state-hover'); onmouseout=jQuery(this).removeClass('ui-state-hover'); ";str=str+"<div title='"+$.jgrid.nav.deltitle+"' style='float:left;margin-left:5px;' class='ui-pg-div ui-inline-del' "+ocl+"><span class='ui-icon ui-icon-trash'></span></div>"}ocl="onclick=jQuery.fn.fmatter.rowactions('"+d+"','"+b.gid+"','save',"+b.pos+"); onmouseover=jQuery(this).addClass('ui-state-hover'); onmouseout=jQuery(this).removeClass('ui-state-hover'); ";str=str+"<div title='"+$.jgrid.edit.bSubmit+"' style='float:left;display:none' class='ui-pg-div ui-inline-save' "+ocl+"><span class='ui-icon ui-icon-disk'></span></div>";ocl="onclick=jQuery.fn.fmatter.rowactions('"+d+"','"+b.gid+"','cancel',"+b.pos+"); onmouseover=jQuery(this).addClass('ui-state-hover'); onmouseout=jQuery(this).removeClass('ui-state-hover'); ";str=str+"<div title='"+$.jgrid.edit.bCancel+"' style='float:left;display:none;margin-left:5px;' class='ui-pg-div ui-inline-cancel' "+ocl+"><span class='ui-icon ui-icon-cancel'></span></div>";return"<div style='margin-left:8px;'>"+str+"</div>"};$.unformat=function(a,b,c,d){var e,formatType=b.colModel.formatter,op=b.colModel.formatoptions||{},sep,re=/([\.\*\_\'\(\)\{\}\+\?\\])/g,unformatFunc=b.colModel.unformat||($.fn.fmatter[formatType]&&$.fn.fmatter[formatType].unformat);if(typeof unformatFunc!=='undefined'&&$.isFunction(unformatFunc)){e=unformatFunc.call(this,$(a).text(),b,a)}else if(!$.fmatter.isUndefined(formatType)&&$.fmatter.isString(formatType)){var f=$.jgrid.formatter||{},stripTag;switch(formatType){case'integer':op=$.extend({},f.integer,op);sep=op.thousandsSeparator.replace(re,"\\$1");stripTag=new RegExp(sep,"g");e=$(a).text().replace(stripTag,'');break;case'number':op=$.extend({},f.number,op);sep=op.thousandsSeparator.replace(re,"\\$1");stripTag=new RegExp(sep,"g");e=$(a).text().replace(stripTag,"").replace(op.decimalSeparator,'.');break;case'currency':op=$.extend({},f.currency,op);sep=op.thousandsSeparator.replace(re,"\\$1");stripTag=new RegExp(sep,"g");e=$(a).text();if(op.prefix&&op.prefix.length){e=e.substr(op.prefix.length)}if(op.suffix&&op.suffix.length){e=e.substr(0,e.length-op.suffix.length)}e=e.replace(stripTag,'').replace(op.decimalSeparator,'.');break;case'checkbox':var g=(b.colModel.editoptions)?b.colModel.editoptions.value.split(":"):["Yes","No"];e=$('input',a).is(":checked")?g[0]:g[1];break;case'select':e=$.unformat.select(a,b,c,d);break;case'actions':return"";default:e=$(a).text()}}return e!==undefined?e:d===true?$(a).text():$.jgrid.htmlDecode($(a).html())};$.unformat.select=function(c,d,e,f){var g=[];var h=$(c).text();if(f===true){return h}var k=$.extend({},!$.fmatter.isUndefined(d.colModel.formatoptions)?d.colModel.formatoptions:d.colModel.editoptions),sep=k.separator===undefined?":":k.separator,delim=k.delimiter===undefined?";":k.delimiter;if(k.value){var l=k.value,msl=k.multiple===true?true:false,scell=[],sv;if(msl){scell=h.split(",");scell=$.map(scell,function(n){return $.trim(n)})}if($.fmatter.isString(l)){var m=l.split(delim),j=0;for(var i=0;i<m.length;i++){sv=m[i].split(sep);if(sv.length>2){sv[1]=$.map(sv,function(n,i){if(i>0){return n}}).join(sep)}if(msl){if($.inArray(sv[1],scell)>-1){g[j]=sv[0];j++}}else if($.trim(sv[1])==$.trim(h)){g[0]=sv[0];break}}}else if($.fmatter.isObject(l)||$.isArray(l)){if(!msl){scell[0]=h}g=$.map(scell,function(n){var b;$.each(l,function(i,a){if(a==n){b=i;return false}});if(typeof(b)!='undefined'){return b}})}return g.join(", ")}else{return h||""}};$.unformat.date=function(a,b){var c=$.jgrid.formatter.date||{};if(!$.fmatter.isUndefined(b.formatoptions)){c=$.extend({},c,b.formatoptions)}if(!$.fmatter.isEmpty(a)){return $.fmatter.util.DateFormat(c.newformat,a,c.srcformat,c)}else{return $.fn.fmatter.defaultFormat(a,b)}}})(jQuery);
